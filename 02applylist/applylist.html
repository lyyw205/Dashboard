<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‘ë‹µì ë¦¬ìŠ¤íŠ¸</title>
  <link rel="stylesheet" href="style-applylist.css" />
  <link rel="stylesheet" href="sidebar.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <div class="sidebar-head">
        <a href="index.html" class="sidebar-head-logo">
          <img class="sidebar-head-loge-img" src="img/logo.png">
        </a>
      </div>
      <ul>
        <li class="list">
          <a href="applylist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/form.png" class="form-icon">
              </span>
              <span class="list-content-text">íŒŒí‹°ì‹ ì²­ì„œ</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/reservationsheet.png" class="form-icon">
              </span>
              <span class="list-content-text">ì˜ˆì•½ì‹œíŠ¸</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/music.png" class="form-icon">
              </span>
              <span class="list-content-text">ë…¸ë˜ì´ˆì„±</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/person.png" class="form-icon">
              </span>
              <span class="list-content-text">ì¸ë¬¼ê²Œì„</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/ppt.png" class="form-icon">
              </span>
              <span class="list-content-text">ì§„í–‰PPT</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">ìº˜ë¦°ë”</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="img/creditcard.png" class="form-icon">
              </span>
              <span class="list-content-text">ì¬ë¬´ê¸°ë¡</span>
            </span>
            <span class="list-content-arrow">
              <img src="/DASHBOARD/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
      </ul>
    </div>
    <div class="table">
      <div class="table-header">
        <h2>ğŸ“‹ ì°¸ì—¬ ì‹ ì²­ì ëª©ë¡</h2>
        <div id="filters">
          <input class="filter-input" type="text" id="search-name" placeholder="ì´ë¦„ ê²€ìƒ‰..." />
          <select id="filter-gender">
            <option value="">ì „ì²´ ì„±ë³„</option>
            <option value="ë‚¨ì">ë‚¨ì</option>
            <option value="ì—¬ì">ì—¬ì</option>
          </select>
          <select id="filter-date">
            <option value="">ì „ì²´ ë‚ ì§œ</option>
            <option value="2025-06-20">2025-06-20</option>
            <option value="2025-06-21">2025-06-21</option>
            <option value="2025-05-30">2025-05-30</option>
          </select>
          <button onclick="loadResponses()">ğŸ” í•„í„° ì ìš©</button>
        </div>
      </div>
      <table class="table-table">
        <thead>
          <tr>
            <th class="submit-time">ì œì¶œì‹œê°</th>
            <th class="submit-name">ì´ë¦„</th>
            <th class="submit-birth">ì¶œìƒë…„ë„</th>
            <th class="submit-phone">ì „í™”ë²ˆí˜¸</th>
            <th class="submit-gender">ì„±ë³„</th>
            <th class="submit-mbti">MBTI</th>
            <th class="submit-date">ì°¸ì—¬ ë‚ ì§œ</th>
            <th class="submit-tmi">TMI</th>
            <th class="automessage-deposit">ì…ê¸ˆë¬¸ì</th>
            <th class="checkbox-deposit">ì…ê¸ˆí™•ì¸</th>
            <th class="automessage-location">ì¥ì†Œë¬¸ì</th>
            <th class="checkbox-afterparty">ì• í”„í„°</th>
            <th class="memo">ë©”ëª¨</th>
          </tr>
        </thead>
        <tbody id="response-table">
          <tr><td colspan="7">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
      </div>
    </div>

  <script>
    const SUPABASE_URL = 'https://wqxmvqqkbxiykiotbusd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadResponses() {
      const nameFilter = document.getElementById('search-name').value.trim();
      const genderFilter = document.getElementById('filter-gender').value;
      const dateFilter = document.getElementById('filter-date').value;

      let query = client.from('responses').select('*').order('created_at', { ascending: false });

      if (genderFilter) query = query.eq('gender', genderFilter);
      if (dateFilter) query = query.eq('apply_date', dateFilter);

      const { data, error } = await query;
      const tableBody = document.getElementById('response-table');
      tableBody.innerHTML = '';

      if (error) {
        console.error('âŒ Supabase ì˜¤ë¥˜:', error);
        tableBody.innerHTML = `<tr><td colspan="7">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      const filtered = data.filter(row => !nameFilter || row.name?.includes(nameFilter));

      if (!filtered.length) {
        tableBody.innerHTML = `<tr><td colspan="7">í•´ë‹¹ ì¡°ê±´ì˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      filtered.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatKoreanShortDate(row.created_at)}</td>
          <td>${row.name}</td>
          <td>${row.birth_year}</td>
          <td>${row.phone}</td>
          <td>${row.gender}</td>
          <td>${row.mbti}</td>
          <td>${formatApplyDate(row.apply_date)}</td>
          <td>${row.tmi || ''}</td>
          <td><input type="text" class="memo-input" data-id="${row.id}" data-field="memo1" value="${row.memo1 || ''}" readonly></td>
          <td><input type="checkbox" class="memo-checkbox" data-id="${row.id}" data-field="memo2" ${row.memo2 === true ? 'checked' : ''}></td>
          <td><input type="text" class="memo-input" data-id="${row.id}" data-field="memo3" value="${row.memo3 || ''}" readonly></td>
          <td><input type="checkbox" class="memo-checkbox" data-id="${row.id}" data-field="memo4" ${row.memo4 === true ? 'checked' : ''}></td>
          <td><input type="text" class="memo-input" data-id="${row.id}" data-field="memo5" value="${row.memo5 || ''}"></td>
        `;
        tableBody.appendChild(tr);
      });

      document.addEventListener("blur", async (e) => {
        if (e.target.classList.contains("memo-input")) {
          const id = e.target.dataset.id;
          const field = e.target.dataset.field;
          const value = e.target.value;

          try {
            const { error } = await client
              .from('responses')
              .update({ [field]: value })
              .eq('id', id);

            if (error) {
              console.error(`âŒ ${field} ì €ì¥ ì‹¤íŒ¨:`, error);
            } else {
              console.log(`âœ… ${field} ì €ì¥ë¨:`, value);
            }
          } catch (err) {
            console.error('âŒ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', err);
          }
        }
      }, true); // useCapture=true â†’ blur ì´ë²¤íŠ¸ ì •ìƒ ê°ì§€
    }

      // ì œì¶œì‹œê° í¬ë§·: "05. 30. 03:09"
      function formatKoreanShortDate(dateString) {
        const date = new Date(dateString);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day   = String(date.getDate()).padStart(2, '0');
        const hour  = String(date.getHours()).padStart(2, '0');
        const min   = String(date.getMinutes()).padStart(2, '0');
        return `${month}. ${day}. ${hour}:${min}`;
      }

      // ì°¸ì—¬ë‚ ì§œ í¬ë§·: "5ì›” 30ì¼ (ê¸ˆ)"
      function formatApplyDate(dateString) {
        const date = new Date(dateString);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const weekday = weekdays[date.getDay()];
        return `${month}ì›” ${day}ì¼ (${weekday})`;
      }


    loadResponses();

      document.addEventListener('change', async (e) => {
        if (e.target.classList.contains('memo-checkbox')) {
          const id = e.target.dataset.id;
          const field = e.target.dataset.field;
          const value = e.target.checked;  // â† ì´ì œ ë¬¸ìì—´ ëŒ€ì‹  boolean(true/false)

          const { error } = await client
            .from('responses')
            .update({ [field]: value })
            .eq('id', id);

          if (error) {
            console.error(`âŒ ${field} ì €ì¥ ì‹¤íŒ¨:`, error);
          } else {
            console.log(`âœ… ${field} ì €ì¥ë¨:`, value);
          }
        }
      });      

      // Realtime êµ¬ë… ì‹œì‘
    const channel = client.channel('realtime:responses');

    channel
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'responses',
          filter: 'memo1=neq.null' // memo1ì´ ì±„ì›Œì§€ëŠ” UPDATEë§Œ ê°ì§€
        },
        payload => {
          console.log('ğŸ“¡ Realtime ë³€ê²½ ê°ì§€ë¨:', payload);
          loadResponses(); // ì‹¤ì‹œê°„ìœ¼ë¡œ í…Œì´ë¸” ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
        }
      )
    .subscribe();
  </script>

</body>
</html>
