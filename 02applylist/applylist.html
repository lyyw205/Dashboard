<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‘ë‹µì ë¦¬ìŠ¤íŠ¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="../common/sidebar.css"/>
  <link rel="stylesheet" href="style-applylist.css" />
</head>
<body>
  <div class="main-content">
    <div class="table-wrapper container-fluid px-4 mt-5">
      <div class="table-header d-flex flex-column mt-5 mt-md-0 mb-3">
        <h2 class="mb-2 mb-md-3">ğŸ“‹ ì°¸ì—¬ ì‹ ì²­ì ëª©ë¡</h2>
        <div id="filters" class="d-flex flex-wrap gap-2 mt-2 mb-3">
          <input class="form-control form-control-sm" type="text" id="search-name" placeholder="ì´ë¦„ ê²€ìƒ‰..." style="max-width: 250px;"/>
          <select id="filter-gender" class="form-select form-select-sm" style="max-width: 100px;">
            <option value="">ì„±ë³„</option>
            <option value="ë‚¨ì">ë‚¨ì</option>
            <option value="ì—¬ì">ì—¬ì</option>
          </select>
          <select id="filter-date" class="form-select form-select-sm">
            <option value="">ë‚ ì§œ</option>
          </select>
          <select id="filter-status" class="form-select form-select-sm" style="max-width: 120px;">
            <option value="">ì‹ ì²­ ìƒíƒœ</option>
            <option value="confirmed">í™•ì •</option>
            <option value="unconfirmed">ë¯¸í™•ì •</option>
          </select>
          <button class="btn btn-dark btn-sm" onclick="loadResponses()">ğŸ” í•„í„° ì ìš©</button>
          <button type="button" class="btn reset-btn btn-sm" onclick="resetFilters()">ğŸ”„ ì´ˆê¸°í™”</button>
          <div class="d-flex flex-wrap gap-2 deposit-search-section">
            <input class="deposit-search-input form-control form-control-sm" type="text" id="search-depositor-name" placeholder="ë¹ ë¥¸ ì…ê¸ˆ í™•ì¸, ì…ê¸ˆìëª…ì„ ì…ë ¥í•˜ì„¸ìš”.." style="max-width: 180px;"/>
            <button class="btn btn-dark btn-sm" id="btn-search-deposit">ğŸ” ì¡°íšŒ</button>
          </div>
        </div>
        <div id="deposit-checker" class="p-3 my-3 border rounded bg-light">
          <div id="deposit-search-results" class="mt-3 mb-3">
            <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
          </div>
        </div>
        <div class="btn-group flex-wrap" role="group" aria-label="ë©”ì‹œì§€ ë°œì†¡ ë²„íŠ¼ ê·¸ë£¹">
          <button type="button" class="btn sendbtn1 message-sender" 
                  data-message-type="resend-failed" 
                  data-confirm-text="[ì´ˆê¸° ì•ˆë‚´ ì¬ì „ì†¡] ì„ íƒí•œ ì‚¬ëŒë“¤ ì¤‘ 'ë°œì†¡ ì‹¤íŒ¨' ìƒíƒœì¸ ê²½ìš°ì—ë§Œ ì¬ë°œì†¡í•©ë‹ˆë‹¤. ì‹¤í–‰í• ê¹Œìš”?">
            ğŸš¨ ì…ê¸ˆì•ˆë‚´
          </button>
          <button type="button" class="btn sendbtn1 message-sender" 
                  data-message-type="reminder" 
                  data-confirm-text="ì„ íƒí•œ ì‚¬ëŒë“¤ì—ê²Œ 'ì…ê¸ˆ ì¬ì´‰' ë¬¸ìë¥¼ ë°œì†¡í• ê¹Œìš”?">
            ğŸ’µ ì…ê¸ˆì¬ì´‰
          </button>
          <button type="button" class="btn sendbtn1 message-sender" 
                  data-message-type="location" 
                  data-confirm-text="ì„ íƒí•œ ì‚¬ëŒë“¤ì—ê²Œ 'ì¥ì†Œ ì•ˆë‚´' ë¬¸ìë¥¼ ë°œì†¡í• ê¹Œìš”?">
            ğŸ“ ì¥ì†Œì•ˆë‚´
          </button>
          
          <!-- 'entrance'ì™€ 'entrance2'ê°€ 'entrance' í•˜ë‚˜ë¡œ í†µí•©ë¨ -->
          <button type="button" class="btn sendbtn1 message-sender" 
                  data-message-type="entrance" 
                  data-confirm-text="ì„ íƒí•œ ì‚¬ëŒë“¤ì—ê²Œ ì¡°ê±´ì— ë§ëŠ” 'ì…ì¥ ì•ˆë‚´' ë¬¸ìë¥¼ ë°œì†¡í• ê¹Œìš”? (ì¼ë°˜/ì´ˆëŒ€ ìë™ êµ¬ë¶„)">
            ğŸ“¢ ì…ì¥ì•ˆë‚´
          </button>

          <!-- 'review', 'review1', 'review2', 'review3'ê°€ 'review' í•˜ë‚˜ë¡œ í†µí•©ë¨ -->
          <button type="button" class="btn sendbtn1 message-sender" 
                  data-message-type="review" 
                  data-confirm-text="ì„ íƒí•œ ì‚¬ëŒë“¤ì—ê²Œ ì¡°ê±´ì— ë§ëŠ” 'í›„ê¸° ìš”ì²­' ë¬¸ìë¥¼ ë°œì†¡í• ê¹Œìš”? (ì„±ë³„/ì¿ í° ë“± ìë™ êµ¬ë¶„)">
            ğŸ“ í›„ê¸°ìš”ì²­
          </button>
        </div> 
      </div>
      <div class="table-responsive">
        <table class="table table-striped-custom table-table table-borderless table-hover align-middle text-nowrap">
          <thead>
            <tr>
              <th class="entrance-check style-checkbox"><input type="checkbox" class="form-check-input" id="check-all-resend"></th>
              <th class="submit-time" data-column="created_at">ì œì¶œì‹œê°</th>
              <th class="submit-name" data-column="name">ì´ë¦„</th>
              <th class="submit-birth" data-column="birth_year">ì¶œìƒë…„ë„</th>
              <th class="submit-phone">ì „í™”ë²ˆí˜¸</th>
              <th class="submit-gender" data-column="gender">ì„±ë³„</th>
              <th class="submit-job">ì§ì—…</th>
              <th class="submit-mbti">MBTI</th>
              <th class="submit-ideal">ì´ìƒí˜•</th>
              <th class="submit-date" data-column="apply_date">ì°¸ì—¬ ë‚ ì§œ</th>
              <th class="submit-coupon">ì¿ í°</th>
              <th class="automessage-deposit">ì…ê¸ˆë¬¸ì</th>
              <th class="automessage-location">ì¶”ê°€ì•ˆë‚´ë¬¸ì</th>
              <th class="checkbox-deposit style-checkbox">ë©”ì¸</th>
              <th class="checkbox-afterparty style-checkbox">ì• í”„í„°</th>
              <th class="memo">ë©”ëª¨</th>
            </tr>
          </thead>
          <tbody id="response-table">
            <tr><td colspan="16" class="text-center text-muted py-3">ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
      <nav aria-label="Page navigation" class="d-flex justify-content-center mt-4">
        <ul class="pagination" id="pagination-controls">
          <!-- í˜ì´ì§€ ë²ˆí˜¸ëŠ” JavaScriptê°€ ë™ì ìœ¼ë¡œ ìƒì„±í•  ê²ƒì…ë‹ˆë‹¤. -->
        </ul>
      </nav>
    </div>
  </div>
  <script>
  // 1. ì „ì—­ ë³€ìˆ˜ ë° í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const SUPABASE_URL = 'https://wqxmvqqkbxiykiotbusd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ITEMS_PER_PAGE = 50; // í•œ í˜ì´ì§€ì— 30ê°œì”©
    let currentPage = 1;

    let currentSortColumn = 'created_at'; // ê¸°ë³¸ ì •ë ¬ ì»¬ëŸ¼
    let currentSortDirection = 'desc';   // ê¸°ë³¸ ì •ë ¬ ë°©í–¥ (ë‚´ë¦¼ì°¨ìˆœ)
    

    // 2. ëª¨ë“  í•¨ìˆ˜ ì •ì˜
    async function populateDateFilter() {
      // 1ë‹¨ê³„ì—ì„œ ë§Œë“  DB í•¨ìˆ˜(RPC)ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
      const { data: dates, error } = await client.rpc('get_distinct_apply_dates');

      if (error) {
        console.error('âŒ ë‚ ì§œ í•„í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
        return;
      }

      const dateSelect = document.getElementById('filter-date');

      // ë°›ì•„ì˜¨ ë‚ ì§œ ëª©ë¡ìœ¼ë¡œ <option> íƒœê·¸ë¥¼ ë§Œë“¤ì–´ ì¶”ê°€í•©ë‹ˆë‹¤.
      dates.forEach(item => {
        const option = document.createElement('option');
        option.value = item.apply_date;
        option.textContent = item.apply_date;
        dateSelect.appendChild(option);
      });
    }

    // ë°ì´í„° ë¡œë”© ë° í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
    async function loadResponses(page = 1) {
      currentPage = page; // í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
      const tableBody = document.getElementById('response-table');
      tableBody.innerHTML = `<tr><td colspan="16" class="text-center text-muted py-5"><span class="spinner-border spinner-border-sm"></span> ë¡œë”© ì¤‘...</td></tr>`;

      const nameFilter = document.getElementById('search-name').value.trim();
      const genderFilter = document.getElementById('filter-gender').value;
      const dateFilter = document.getElementById('filter-date').value;
      const statusFilter = document.getElementById('filter-status').value;
      
      const from = (page - 1) * ITEMS_PER_PAGE;
      const to = page * ITEMS_PER_PAGE - 1;

      let query = client
        .from('responses')
        // â˜…â˜…â˜… { count: 'exact' } ë¡œ ì „ì²´ ê°œìˆ˜ë¥¼ í•¨ê»˜ ê°€ì ¸ì˜µë‹ˆë‹¤. â˜…â˜…â˜…
        .select('*', { count: 'exact' }) 
        .order(currentSortColumn, { ascending: currentSortDirection === 'asc' });

      if (nameFilter) query = query.ilike('name', `%${nameFilter}%`);
      if (genderFilter) query = query.eq('gender', genderFilter);
      if (dateFilter) query = query.eq('apply_date', dateFilter);
      if (statusFilter === 'confirmed') {
        // 'í™•ì •' ì¡°ê±´: memo2ê°€ trueì´ê±°ë‚˜ ë˜ëŠ” memo4ê°€ trueì¸ ê²½ìš°
        // Supabaseì˜ or() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        query = query.or('memo2.is.true,memo4.is.true');
      } else if (statusFilter === 'unconfirmed') {
        // 'ë¯¸í™•ì •' ì¡°ê±´: memo2ê°€ trueê°€ ì•„ë‹ˆê³  ê·¸ë¦¬ê³  memo4ë„ trueê°€ ì•„ë‹Œ ê²½ìš°
        // (nullê³¼ falseë¥¼ ëª¨ë‘ í¬í•¨í•˜ê¸° ìœ„í•´ .not('...', 'is', 'true')ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤)
        query = query.not('memo2', 'is', 'true').not('memo4', 'is', 'true');
      }
      
      // â˜…â˜…â˜… .range() ë¡œ í•„ìš”í•œ ë§Œí¼ë§Œ ë°ì´í„°ë¥¼ ìë¦…ë‹ˆë‹¤. â˜…â˜…â˜…
      query = query.range(from, to);

      const { data, error, count } = await query; // count ë³€ìˆ˜ ì¶”ê°€
      tableBody.innerHTML = '';

      if (error) {
        console.error('âŒ Supabase ì˜¤ë¥˜:', error);
        tableBody.innerHTML = `<tr><td colspan="16">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }
      
      if (!data.length) {
        tableBody.innerHTML = `<tr><td colspan="16">í•´ë‹¹ ì¡°ê±´ì˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        renderPagination(0); // í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¸°ê¸°
        return;
      }

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="entrance-check style-checkbox">
            <input type="checkbox" class="form-check-input row-checkbox" data-id="${row.id}">
          </td>
          <td class="submit-time">${formatKoreanShortDate(row.created_at)}</td>
          <td class="submit-name">${row.name || ''}</td>
          <td class="submit-birth">${row.birth_year || ''}</td>
          <td class="submit-phone">${row.phone || ''}</td>
          <td class="submit-gender">${row.gender || ''}</td>
          <td class="submit-job" title="${row.job || ''}">${row.job || ''}</td>
          <td class="submit-mbti" title="${row.mbti || ''}">${row.mbti || ''}</td>
          <td class="submit-ideal" title="${row.ideal || ''}">${row.ideal || ''}</td>
          <td class="submit-date">${row.apply_date ? formatApplyDate(row.apply_date) : ''}</td>
          <td class="submit-coupon">${row.coupon || ''}</td>
          <td class="automessage-deposit"><input type="text" class="memo-input" data-id="${row.id}" data-field="memo1" title="${row.memo1 || ''}" value="${row.memo1 || ''}"></td>
          <td class="automessage-location"><input type="text" class="memo-input" data-id="${row.id}" data-field="memo3" title="${row.memo3 || ''}" value="${row.memo3 || ''}"></td>
          <td class="style-checkbox"><input type="checkbox" class="form-check-input memo-checkbox" data-id="${row.id}" data-field="memo2" ${row.memo2 === true ? 'checked' : ''}></td>
          <td class="style-checkbox"><input type="checkbox" class="form-check-input memo-checkbox" data-id="${row.id}" data-field="memo4" ${row.memo4 === true ? 'checked' : ''}></td>
          <td><input type="text" class="memo-input memo" data-id="${row.id}" data-field="memo5" title="${row.memo5 || ''}" value="${row.memo5 || ''}"></td>
        `;
        tableBody.appendChild(tr);
      });
          // â˜…â˜…â˜… ì „ì²´ ê°œìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ë„¤ì´ì…˜ UIë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. â˜…â˜…â˜…
    renderPagination(count);
  }
    function resetFilters() {
      // 1. ëª¨ë“  í•„í„° ì…ë ¥ ìš”ì†Œì˜ ê°’ì„ ê¸°ë³¸ê°’('')ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
      document.getElementById('search-name').value = '';
      document.getElementById('filter-gender').value = '';
      document.getElementById('filter-date').value = '';
      document.getElementById('filter-status').value = '';
      document.getElementById('deposit-checker').style.display = 'none';

      // 2. í•„í„°ê°€ í•´ì œëœ ìƒíƒœë¡œ ì²« í˜ì´ì§€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      loadResponses(1);
    }

      // â˜…â˜…â˜… [ì‹ ê·œ] í˜ì´ì§€ë„¤ì´ì…˜ UIë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ â˜…â˜…â˜…
    function renderPagination(totalItems) {
      const paginationContainer = document.getElementById('pagination-controls');
      paginationContainer.innerHTML = '';
      
      if (totalItems === 0) return;

      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

      if (totalPages <= 1) return; // 1í˜ì´ì§€ ì´í•˜ë©´ êµ³ì´ í‘œì‹œ ì•ˆ í•¨
      
      let paginationHTML = '';
      
      // 'ì´ì „' ë²„íŠ¼
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadResponses(${currentPage - 1})"><</a>
        </li>
      `;

      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadResponses(${i})">${i}</a>
          </li>
        `;
      }
      
      // 'ë‹¤ìŒ' ë²„íŠ¼
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="loadResponses(${currentPage + 1})">></a>
        </li>
      `;
      
      paginationContainer.innerHTML = paginationHTML;
    }

    // â˜…â˜…â˜… [ì‹ ê·œ] ì„ íƒëœ í•­ëª©ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë²”ìš© í•¨ìˆ˜ â˜…â˜…â˜…
    async function handleSendMessage(button) {
      const messageType = button.dataset.messageType;
      const confirmText = button.dataset.confirmText;

      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkedBoxes.length === 0) {
        alert('ë¬¸ìë¥¼ ë³´ë‚¼ ëŒ€ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const checkedIds = Array.from(checkedBoxes).map(box => box.dataset.id);
      if (!confirm(confirmText)) return;
      
      // í•˜ë‚˜ì˜ ë²”ìš© ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
      const SEND_MESSAGE_URL = 'https://grldashboard.netlify.app/.netlify/functions/resend-selected';
      
      const originalButtonHTML = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì²˜ë¦¬ ì¤‘...';

      try {
        const response = await fetch(SEND_MESSAGE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: messageType, ids: checkedIds }),
        });
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        
        alert(`ìš”ì²­ ì™„ë£Œ!\n\n${result.message}`);
        loadResponses(currentPage); // í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ
        document.getElementById('check-all-resend').checked = false; // ì „ì²´ ì„ íƒ í•´ì œ

      } catch (error) {
        console.error(`âŒ ë©”ì‹œì§€ ë°œì†¡ ìš”ì²­ ì‹¤íŒ¨ (íƒ€ì…: ${messageType}):`, error);
        alert(`ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.message}`);
      } finally {
        button.disabled = false;
        button.innerHTML = originalButtonHTML;
      }
    }

    // ë‚ ì§œ í¬ë§·íŒ… í—¬í¼ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼)
    function formatKoreanShortDate(dateString) {
      if(!dateString) return '';
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const min = String(date.getMinutes()).padStart(2, '0');
      return `${month}. ${day}. ${hour}:${min}`;
    }

    function formatApplyDate(dateString) {
      if(!dateString) return '';
      const date = new Date(dateString);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const weekday = weekdays[date.getDay()];
      return `${month}ì›” ${day}ì¼ (${weekday})`;
    }


    // 3. í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰ë  ë©”ì¸ ë¡œì§
    // 3. í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰ë  ë©”ì¸ ë¡œì§
    document.addEventListener('DOMContentLoaded', () => {
        // â˜…â˜…â˜… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • â˜…â˜…â˜…
        const tableHeader = document.querySelector('.table-header');

        // table-header ì˜ì—­ ë‚´ì—ì„œ ë°œìƒí•˜ëŠ” í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ê°ì§€ (ì´ë²¤íŠ¸ ìœ„ì„)
        tableHeader.addEventListener('click', (e) => {
            // 'í•„í„° ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
            if (e.target.matches('#filters button')) {
                loadResponses(1);
            }
            // 'ë©”ì‹œì§€ ë°œì†¡' ë²„íŠ¼(ê³µí†µ í´ë˜ìŠ¤ .message-sender)ì„ í´ë¦­í•œ ê²½ìš°
            if (e.target.matches('.message-sender')) {
                handleSendMessage(e.target);
            }
        });

        // Enter í‚¤ë¡œ ì´ë¦„ ê²€ìƒ‰ í•„í„° ì ìš©
        document.getElementById('search-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadResponses(1);
            }
        });

        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.addEventListener('wheel', (event) => {
                if (!event.shiftKey && tableContainer.scrollWidth > tableContainer.clientWidth) {
                    event.preventDefault();
                    tableContainer.scrollLeft += event.deltaY;
                }
            });
        }

        const tableWrapper = document.querySelector('.table-wrapper');
        // í…ìŠ¤íŠ¸ ë©”ëª¨ ì €ì¥
        tableWrapper.addEventListener('blur', async (e) => {
            if (e.target.classList.contains('memo-input') && !e.target.readOnly) {
                const id = e.target.dataset.id;
                const field = e.target.dataset.field;
                const value = e.target.value;
                const { error } = await client.from('responses').update({ [field]: value }).eq('id', id);
                if (error) console.error(`âŒ ${field} ì €ì¥ ì‹¤íŒ¨:`, error);
                else console.log(`âœ… ${field} ì €ì¥ë¨:`, value);
            }
        }, true);
          
        // ì²´í¬ë°•ìŠ¤ ë©”ëª¨ ì €ì¥
        tableWrapper.addEventListener('change', async (e) => {
            if (e.target.classList.contains('memo-checkbox')) {
                const id = e.target.dataset.id;
                const field = e.target.dataset.field;
                const value = e.target.checked;
                const { error } = await client.from('responses').update({ [field]: value }).eq('id', id);
                if (error) console.error(`âŒ ${field} ì €ì¥ ì‹¤íŒ¨:`, error);
                else console.log(`âœ… ${field} ì €ì¥ë¨:`, value);
            }
        });
        
        // 'ì „ì²´ ì„ íƒ' ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥
        const checkAll = document.getElementById('check-all-resend');
        checkAll.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        const sortableHeaders = document.querySelectorAll('thead th[data-column]');

        sortableHeaders.forEach(header => {
          header.addEventListener('click', () => {
            const clickedColumn = header.dataset.column;

            // ì—£ì§€ ì¼€ì´ìŠ¤: ê¸°ë³¸ ì •ë ¬ ìƒíƒœ('created_at', 'desc')ì—ì„œ 'created_at' í—¤ë”ë¥¼ ì²˜ìŒ í´ë¦­í•œ ê²½ìš°
            const isFirstClickOnDefault = (currentSortColumn === 'created_at' && currentSortDirection === 'desc' && clickedColumn === 'created_at');

            // Case 1: ìƒˆë¡œìš´ ì»¬ëŸ¼ì„ í´ë¦­í–ˆê±°ë‚˜, ìœ„ì—ì„œ ì •ì˜í•œ ì—£ì§€ ì¼€ì´ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ê²½ìš°
            if (currentSortColumn !== clickedColumn || isFirstClickOnDefault) {
              currentSortColumn = clickedColumn;
              currentSortDirection = 'asc'; // í•­ìƒ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
            } 
            // Case 2: ê·¸ ì™¸ì˜ ê²½ìš° (í™œì„±í™”ëœ ì»¬ëŸ¼ì„ í† ê¸€í•˜ëŠ” ê²½ìš°)
            else {
              // í˜„ì¬ ì˜¤ë¦„ì°¨ìˆœ('asc')ì´ì—ˆë‹¤ë©´ -> ë‚´ë¦¼ì°¨ìˆœ('desc')ìœ¼ë¡œ ë³€ê²½
              if (currentSortDirection === 'asc') {
                currentSortDirection = 'desc';
              }
              // í˜„ì¬ ë‚´ë¦¼ì°¨ìˆœ('desc')ì´ì—ˆë‹¤ë©´ -> ê¸°ë³¸ ì •ë ¬(ì´ˆê¸°í™”)ë¡œ ë³€ê²½
              else {
                currentSortColumn = 'created_at';
                currentSortDirection = 'desc';
              }
            }

            loadResponses(1);
            updateSortIndicators();
          });
        });

        // â–¼â–¼â–¼ [ì¶”ê°€] ì •ë ¬ í™”ì‚´í‘œë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ â–¼â–¼â–¼
        function updateSortIndicators() {
          // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ ê´€ë ¨ í´ë˜ìŠ¤ë¥¼ ì¼ë‹¨ ì œê±°
          sortableHeaders.forEach(header => {
            header.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
          });

          // í˜„ì¬ ì •ë ¬ ê¸°ì¤€ì´ ë˜ëŠ” í—¤ë”ë¥¼ ì°¾ìŒ
          const activeHeader = document.querySelector(`th[data-column="${currentSortColumn}"]`);
          
          if (activeHeader) {
            // ì°¾ì€ í—¤ë”ì— 'sorted'ì™€ í˜„ì¬ ì •ë ¬ ë°©í–¥ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€
            activeHeader.classList.add('sorted');
            activeHeader.classList.add(`sorted-${currentSortDirection}`);
          }
        }
                // â–¼â–¼â–¼ [ì‹ ê·œ] ì…ê¸ˆ ë‚´ì—­ ë¹ ë¥¸ ì¡°íšŒ ê¸°ëŠ¥ â–¼â–¼â–¼

        // 1. í•„ìš”í•œ HTML ìš”ì†Œë¥¼ ë³€ìˆ˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
        const searchDepositBtn = document.getElementById('btn-search-deposit');
        const searchDepositInput = document.getElementById('search-depositor-name');
        const depositResultsContainer = document.getElementById('deposit-search-results');

        // 2. ì¡°íšŒ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        searchDepositBtn.addEventListener('click', searchDeposits);

        // 3. ê²€ìƒ‰ ì¸í’‹ì—ì„œ Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œë„ ì¡°íšŒê°€ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
        searchDepositInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchDeposits();
            }
        });

        // 4. Supabase DBì—ì„œ ì…ê¸ˆ ë‚´ì—­ì„ ê²€ìƒ‰í•˜ê³  ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ì…ë‹ˆë‹¤.
        async function searchDeposits() {
            document.getElementById('deposit-checker').style.display = 'block';

            const depositorName = searchDepositInput.value.trim();

            if (!depositorName) {
                alert('ê²€ìƒ‰í•  ì…ê¸ˆìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
            depositResultsContainer.innerHTML = `<div class="text-center text-muted p-2"><span class="spinner-border spinner-border-sm"></span> ê²€ìƒ‰ ì¤‘...</div>`;

            try {
                // [ìˆ˜ì •] select êµ¬ë¬¸ì— 'category', 'type'ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
                const { data, error } = await client
                    .from('card_logs') // ì¹´ë“œ ê²°ì œ ë‚´ì—­ í…Œì´ë¸”
                    .select('timeline, store, amount, category, type') // í•„ìš”í•œ ì»¬ëŸ¼ ì„ íƒ
                    .eq('type', 'ì…ê¸ˆ') // 'ì…ê¸ˆ' ë‚´ì—­ë§Œ ì¡°íšŒ
                    .ilike('store', `%${depositorName}%`) // ì…ë ¥í•œ ì´ë¦„ì„ í¬í•¨í•˜ëŠ” ëª¨ë“  ë‚´ì—­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                    .order('timeline', { ascending: false }) // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                    .limit(10); // ìµœëŒ€ 10ê°œê¹Œì§€ ê²°ê³¼ í‘œì‹œ

                if (error) {
                    throw error; // ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ catch ë¸”ë¡ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
                }
                
                // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í™”ë©´ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                renderDepositResults(data);

            } catch (error) {
                console.error('âŒ ì…ê¸ˆ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
                depositResultsContainer.innerHTML = `<div class="text-center text-danger p-2">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        // 5. ì¡°íšŒëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTMLì„ ë§Œë“¤ì–´ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
        function renderDepositResults(results) {
            if (!results || results.length === 0) {
                depositResultsContainer.innerHTML = `<div class="text-center text-muted p-3" style="background-color: #f5f5f5;">ì¼ì¹˜í•˜ëŠ” ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            // [ìˆ˜ì •] ê²°ê³¼ í…Œì´ë¸”ì˜ í—¤ë”ì— 'ì¹´í…Œê³ ë¦¬'ì™€ 'ì¢…ë¥˜'ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            let resultsHTML = `
              <div class="result-item result-header">
                <span class="result-time">ì…ê¸ˆ ì‹œê°</span>
                <span class="result-category">ì¹´í…Œê³ ë¦¬</span>
                <span class="result-type">ì¢…ë¥˜</span>
                <span class="result-name">ì…ê¸ˆìëª…</span>
                <span class="result-amount">ê¸ˆì•¡</span>
              </div>
            `;

            // [ìˆ˜ì •] ê° ê²°ê³¼ í–‰ì— row.categoryì™€ row.typeì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            results.forEach(row => {
                const depositDate = new Date(row.timeline);
                const formattedDate = `${String(depositDate.getMonth() + 1).padStart(2, '0')}.${String(depositDate.getDate()).padStart(2, '0')}. ${String(depositDate.getHours()).padStart(2, '0')}:${String(depositDate.getMinutes()).padStart(2, '0')}`;
                
                resultsHTML += `
                  <div class="result-item">
                    <span class="result-time">${formattedDate}</span>
                    <span class="result-category">${row.category || '-'}</span>
                    <span class="result-type">${row.type || '-'}</span>
                    <span class="result-name">${row.store}</span>
                    <span class="result-amount">${row.amount.toLocaleString('ko-KR')}ì›</span>
                  </div>
                `;
            });

            depositResultsContainer.innerHTML = resultsHTML;
        }
          
        // ì´ˆê¸° ë°ì´í„° ë¡œë”©
        populateDateFilter();
        loadResponses(currentPage);
        updateSortIndicators();
    });
    
    // 4. ì‹¤ì‹œê°„ êµ¬ë… ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
    client.channel('realtime:responses')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'responses' }, 
        payload => {
          console.log('ğŸ“¡ Realtime ë³€ê²½ ê°ì§€ë¨:', payload);
          loadResponses(currentPage); // INSERT, UPDATE, DELETE ëª¨ë“  ë³€ê²½ì— ëŒ€í•´ í…Œì´ë¸” ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
        }
      )
      .subscribe();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
