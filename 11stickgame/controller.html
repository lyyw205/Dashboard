<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>π¨ μ»¬λ¬ PPT μ»¨νΈλ΅¤λ¬</title>
  <link rel="stylesheet" href="stickgame.css">
  <link rel="stylesheet" href="/common/sidebar.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body>
  <div class="stickgame-wrapper main-content">
    <div class="container-fluid px-4 mt-5">
      <div class="game-wrapper d-flex flex-column mt-5 mt-md-0 mb-3">
        <h2 class="mb-3 mb-md-3">π¨ PPT μ¬λΌμ΄λ“ μ΅°ν•© μ…λ ¥</h2>
        <div class="use-manual"><div class="use-manual-title">μ‚¬μ©λ°©λ²•</div><div class="use-manual-text">1. μƒ‰μƒμ½”λ“(ex. #ffffff), μƒ‰μƒλ…(ex. #λΉ¨κ°•), ν‚¤μ›λ“(ex. #κ¶ν•©)μ„ λ¨λ‘ μ±„μ΄λ‹¤.<br>-> 3κ°λ¥Ό λ¨λ‘ μ±„μ°μ§€ μ•μ€ ν–‰μ€ pptμ—μ„ μ μ™Έλ¨<br>2. λ‚μ¤λ” μμ„λ¥Ό μ§€μ •ν•κ³  μ‹¶μ€ μƒ‰μƒμ€ μ™Όμ½ μ²΄ν¬λ°•μ¤λ¥Ό ν΄λ¦­ν•κ³  μ›ν•λ” μμ„λ¥Ό μ…λ ¥ν•λ‹¤<br>-> 6μ„ μ…λ ¥ν•λ©΄ 6λ²μ§Έλ΅ λ‚μ΄ <br>3. PPTμ‹μ‘ν•κΈ° λ²„νΌμ„ λ„λ¥Έλ‹¤</div></div>
        <div id="input-container"></div>
        <button onclick="startPPT()" class="ppt-start-button">PPT μ‹μ‘ν•κΈ°</button>
      </div>
    </div>
  </div>
  <script>
    // β… 1. λ‚μ¤‘μ— ν–‰ κ°μλ¥Ό λ°”κΎΈλ ¤λ©΄ μ—¬κΈ° μ«μλ§ λ°”κΎΈμ„Έμ” (μ: 10)
    const numberOfRows = 8;
    const defaultColors = ['#ff4747', '#fda83f', '#feee39', '#36b51c', '#000000', '#2937a3', '#844ca9', '#ececec'];
    const defaultTextsA = ['#λΉ¨κ°•', '#μ£Όν™©', '#λ…Έλ‘', '#μ΄λ΅', '#λ‚¨μƒ‰', '#λ³΄λΌ', '#λ³΄λΌ', '#μ„ νƒ'];
    // --- μ„¤μ • μμ—­ λ ---

    const inputContainer = document.getElementById("input-container");

    // --- UI μƒμ„± ---
    for (let i = 0; i < numberOfRows; i++) {
      const group = document.createElement("div");
      group.className = "set-group";
      const currentColor = defaultColors[i] || '#ececec';
      const currentTextA = defaultTextsA[i] || '';

      // β… UI λ³€κ²½: 'κ³ μ •' ν…μ¤νΈλ¥Ό μ«μ μ…λ ¥μΉΈμΌλ΅ κµμ²΄
      group.innerHTML = `
        <label class="lock-label">
          <input type="checkbox" class="lock-checkbox">
          <!-- μ«μ μ…λ ¥μΉΈ μ¶”κ°€. μ²μμ—” λΉ„ν™μ„±ν™” μƒνƒ -->
          <input type="number" class="position-input" min="1" max="${numberOfRows}" disabled>
        </label>
        <input type="color" class="color-picker" value="${currentColor}" />
        <input type="text" class="color-code" value="${currentColor}" placeholder="#μ»¬λ¬μ½”λ“" />
        <input type="text" class="textA-input" value="${currentTextA}" placeholder="μƒ‰μƒ (ex. #λΉ¨κ°•)" />
        <input type="text" class="textB-input" placeholder="ν‚¤μ›λ“ (ex. #κ¶ν•©)" />
      `;
      
      const checkbox = group.querySelector('.lock-checkbox');
      const positionInput = group.querySelector('.position-input');

      // β… μ΄λ²¤νΈ μ¶”κ°€: μ²΄ν¬λ°•μ¤λ¥Ό λ„λ¥Ό λ•λ§λ‹¤ μ«μ μ…λ ¥μΉΈμ„ ν™μ„±ν™”/λΉ„ν™μ„±ν™”
      checkbox.addEventListener('change', () => {
        positionInput.disabled = !checkbox.checked;
        if (!checkbox.checked) {
          positionInput.value = ''; // μ²΄ν¬ ν•΄μ  μ‹ μ…λ ¥κ°’ μ΄κΈ°ν™”
        }
      });

      const colorPicker = group.querySelector(".color-picker");
      const colorCode = group.querySelector(".color-code");
      colorPicker.addEventListener("input", () => { colorCode.value = colorPicker.value; });
      colorCode.addEventListener("input", () => { if (/^#([0-9A-Fa-f]{6})$/.test(colorCode.value)) { colorPicker.value = colorCode.value; } });
      
      inputContainer.appendChild(group);
    }

    // β… startPPT ν•¨μ λ΅μ§μ„ μ™„μ „ν μƒλ΅ μ‘μ„±ν•©λ‹λ‹¤.
    function startPPT() {
      // 1. λ¨λ“  μ…λ ¥κ°’ (μƒ‰μƒ, ν…μ¤νΈ, μ²΄ν¬μƒνƒ, μμ„)μ„ κ°€μ Έμµλ‹λ‹¤.
      const colors = [...document.querySelectorAll(".color-code")].map(input => input.value);
      const textsA = [...document.querySelectorAll(".textA-input")].map(input => input.value);
      const textsB = [...document.querySelectorAll(".textB-input")].map(input => input.value);
      const lockStates = [...document.querySelectorAll(".lock-checkbox")].map(input => input.checked);
      const positions = [...document.querySelectorAll(".position-input")].map(input => parseInt(input.value, 10));

      const totalRows = numberOfRows;
      const finalSets = new Array(totalRows).fill(null);
      const unlockedSets = [];
      
      // 2. [λ§¤μ° μ¤‘μ”] μμ„ μ ν¨μ„± κ²€μ‚¬ (μ¤‘λ³µ λ° λ²”μ„ ν™•μΈ)
      const claimedPositions = new Set();
      for (let i = 0; i < totalRows; i++) {
        if (lockStates[i]) { // κ³ μ • μ²΄ν¬λ ν•­λ©λ§ κ²€μ‚¬
          const pos = positions[i];
          if (isNaN(pos) || pos < 1 || pos > totalRows) {
            alert(`μ¤λ¥: ${i + 1}λ²μ§Έ ν–‰μ μμ„λ” 1κ³Ό ${totalRows} μ‚¬μ΄μ μ«μμ—¬μ•Ό ν•©λ‹λ‹¤.`);
            return;
          }
          if (claimedPositions.has(pos)) {
            alert(`μ¤λ¥: μμ„ ${pos}λ²μ΄ μ¤‘λ³µμΌλ΅ μ§€μ •λμ—μµλ‹λ‹¤. ν•λ‚μ μμ„μ—λ” ν•λ‚μ ν–‰λ§ κ³ μ •ν•  μ μμµλ‹λ‹¤.`);
            return;
          }
          claimedPositions.add(pos);
        }
      }

      // 3. μ ν¨μ„± κ²€μ‚¬ ν†µκ³Ό ν›„, μ¬λΌμ΄λ“ λ°°μΉ μ‹μ‘
      for (let i = 0; i < totalRows; i++) {
        if (textsA[i].trim() && textsB[i].trim()) {
          const slideSet = [
            { bg: colors[i], text: textsA[i] },
            { bg: colors[i], text: textsB[i] }
          ];

          if (lockStates[i]) {
            // μ‚¬μ©μκ°€ μ…λ ¥ν• μμ„(1-based)λ¥Ό λ°°μ—΄ μΈλ±μ¤(0-based)λ΅ λ³€ν™
            const targetIndex = positions[i] - 1;
            finalSets[targetIndex] = slideSet;
          } else {
            unlockedSets.push(slideSet);
          }
        }
      }

      // 4. λ‚λ¨Έμ§€ λ΅μ§μ€ μ΄μ „κ³Ό λ™μΌ (λλ¤ μ„ΈνΈ μ„κ³ , λΉμλ¦¬μ— μ±„μ°κΈ°)
      const shuffledUnlocked = unlockedSets.sort(() => Math.random() - 0.5);
      
      let unlockedIndex = 0;
      for (let i = 0; i < finalSets.length; i++) {
        if (finalSets[i] === null) {
          if (unlockedIndex < shuffledUnlocked.length) {
            finalSets[i] = shuffledUnlocked[unlockedIndex];
            unlockedIndex++;
          }
        }
      }

      // β… --- μ΄ λ¶€λ¶„μ΄ ν•µμ‹¬ μμ •μ‚¬ν•­μ…λ‹λ‹¤ --- β…

      // 5. μ ν¨ν• μ„ΈνΈ(nullμ΄ μ•„λ‹ κ²ƒ)λ§ λ¨Όμ € ν•„ν„°λ§ν•©λ‹λ‹¤.
      const validSets = finalSets.filter(set => set !== null);

      // 6. κ° μ„ΈνΈ μ‚¬μ΄μ— κ²€μ€μƒ‰ μ¬λΌμ΄λ“λ¥Ό μ¶”κ°€ν•μ—¬ μµμΆ… μ¬λΌμ΄λ“ λ©λ΅μ„ λ§λ“­λ‹λ‹¤.
      const slidesToSend = validSets.flatMap((set, index) => {
        // κ²€μ€μƒ‰ λΉ μ¬λΌμ΄λ“ κ°μ²΄ μ •μ
        const blackSlide = { bg: '#000000', text: 'μ¶λ°!' };

        // ν„μ¬ μ„ΈνΈκ°€ λ§μ§€λ§‰ μ„ΈνΈκ°€ μ•„λ‹λΌλ©΄, μ„ΈνΈ λ’¤μ— κ²€μ€ μ¬λΌμ΄λ“λ¥Ό μ¶”κ°€ν•©λ‹λ‹¤.
        if (index < validSets.length - 1) {
          return [...set, blackSlide]; // ex: [μƒ‰μƒμ¬λΌμ΄λ“, ν‚¤μ›λ“μ¬λΌμ΄λ“, κ²€μ€μ¬λΌμ΄λ“]
        } else {
          // λ§μ§€λ§‰ μ„ΈνΈλΌλ©΄, κ²€μ€ μ¬λΌμ΄λ“λ¥Ό μ¶”κ°€ν•μ§€ μ•μµλ‹λ‹¤.
          return set;
        }
      });
      // --- β… μμ • λ --- β…
      
      if (slidesToSend.length === 0) {
        alert("μ ν¨ν• μ¬λΌμ΄λ“ μ΅°ν•©μ΄ μ—†μµλ‹λ‹¤.");
        return;
      }

      const displayWindow = window.open("display.html", "display_color", "width=1000,height=700");
      setTimeout(() => {
        displayWindow.postMessage({ type: "colorppt", slides: slidesToSend }, "*");
      }, 500);
    }
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
