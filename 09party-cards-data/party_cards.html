<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒŒí‹° ì¹´ë“œ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="party_cards.css">
  <link rel="stylesheet" href="../common/sidebar.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="party_cards main-content">
    <div class="table-wrapper container-fluid px-4 mt-5">
      <div class="party_cards-main d-flex flex-column mt-5 mt-md-0 mb-3">
        <h2 class="mb-3 mb-md-3">ğŸ“‹ íŒŒí‹° ì¹´ë“œ ìˆ˜ì •</h2>
        <div class="table-responsive">
          <table id="party-table" class="table table-striped-custom table-table table-borderless table-hover align-middle text-nowrap">
            <thead class="table-header-wrapper">
              <tr>
                <th>ìˆœì„œ</th>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ì¥ì†Œ</th>
                <th>ì„±ë¹„</th>
                <th>ë§ˆê°ì¼ì‹œ</th>
                <th>í¼ URL</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="btn row-buttons">
        <button class="add-row-btn btn">+ í–‰ ì¶”ê°€</button>
        <button id="save-button" class="btn">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
      </div>
    </div>
  </div>
  <script>
    const supabase = window.supabase.createClient(
      "https://wqxmvqqkbxiykiotbusd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk"
    );

    const fields = ["title", "date", "time", "location", "gender", "deadline", "form_url"];
    const tbody = document.querySelector("#party-table tbody");

    function formatDeadline(deadlineStr) {
        if (!deadlineStr || !deadlineStr.includes('T')) {
            // ì´ë¯¸ 'YYYY-MM-DD HH:mm' í˜•ì‹ì´ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            return deadlineStr || "";
        }

        const date = new Date(deadlineStr);
        // getTimezoneOffset()ì€ ë¶„ ë‹¨ìœ„ ì˜¤í”„ì…‹ì„ ë°˜í™˜ (KSTì˜ ê²½ìš° -540)
        // UTCì™€ KSTì˜ ì°¨ì´ëŠ” -540ë¶„ì´ë¯€ë¡œ, UTC ì‹œê°„ì— ì´ ì°¨ì´ë¥¼ ë¹¼ì£¼ë©´ KSTê°€ ë©ë‹ˆë‹¤.
        const offset = date.getTimezoneOffset() * 60000; // ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        const localTime = new Date(date.getTime() - offset);

        // ì´ì œ localTimeì€ KST ê¸°ì¤€ ì‹œê°„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
        // ì´ ì‹œê°„ì„ "YYYY-MM-DDTHH:mm:ss.sssZ" í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ê³  í•„ìš”í•œ ë¶€ë¶„ë§Œ ì˜ë¼ëƒ…ë‹ˆë‹¤.
        const isoString = localTime.toISOString(); // ê²°ê³¼: "2025-08-01T20:00:00.000Z"
        
        // "YYYY-MM-DD HH:mm" í˜•ì‹ìœ¼ë¡œ ìµœì¢… ë°˜í™˜
        return isoString.substring(0, 16).replace('T', ' ');
    }

    function createRow(row = {}, id = "") {
      const tr = document.createElement("tr");
      tr.dataset.id = id;

      // âœ… ë¼ë²¨ í…ìŠ¤íŠ¸ì™€ keyë¥¼ ë§¤í•‘
      const labels = {
        title: "ì œëª©",
        date: "ë‚ ì§œ",
        time: "ì‹œê°„",
        location: "ì¥ì†Œ",
        gender: "ì„±ë¹„",
        deadline: "ë§ˆê°ì¼ì‹œ",
        form_url: "í¼ URL"
      };

      fields.forEach(key => {
        const td = document.createElement("td");
        td.dataset.key = key;
        td.setAttribute("data-label", labels[key]); // âœ… ë¼ë²¨ ì†ì„± ì¶”ê°€

        const value = key === "deadline" && row[key]
          ? formatDeadline(row[key])
          : (row[key] ?? "");

        td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
        tr.appendChild(td);
      });

      // ì‚­ì œ ë²„íŠ¼ ì—´
      const deleteTd = document.createElement("td");
      deleteTd.setAttribute("data-label", "ì‚­ì œ"); // âœ… ì‚­ì œ ë²„íŠ¼ë„ ë¼ë²¨ ì¶”ê°€
      deleteTd.innerHTML = `
        <button class="delete-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg>
        </button>`;
      tr.appendChild(deleteTd);

      tbody.appendChild(tr);

      // âœ… ëª¨ë°”ì¼ì¼ ë•Œë§Œ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
      if (window.innerWidth < 768) {
        setTimeout(() => {
          tr.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 50); // ë Œë” íƒ€ì´ë° í™•ë³´
      }
    }

    async function loadData() {
      const { data, error } = await supabase
        .from("party_cards")
        .select("*")
        .order("date", { ascending: true });

      if (error) return alert("âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message);
      tbody.innerHTML = "";
      data.forEach(row => createRow(row, row.id));
    }

    document.querySelector(".add-row-btn").addEventListener("click", () => {
      createRow(); // ë¹ˆ í–‰ ì¶”ê°€
    });

    document.getElementById("save-button").addEventListener("click", async () => {
      const rows = document.querySelectorAll("tbody tr");

      for (const tr of rows) {
        const id = tr.dataset.id?.trim();  // âœ… ê³µë°± ì œê±°ë„ í¬í•¨
        const cells = tr.querySelectorAll("td[data-key]");
        const rowData = {};

        cells.forEach(td => {
          const key = td.dataset.key;
          const input = td.querySelector("input");
          rowData[key] = input.value.trim();
        });

        const isEmpty = Object.values(rowData).every(v => v === "");
        if (isEmpty) continue;

        // ë§ˆê°ì¼ì‹œ ë³€í™˜
        if (rowData.deadline) {
            // ì…ë ¥ê°’ì— 'T'ë‚˜ 'Z'ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€, 'YYYY-MM-DD HH:mm' ê°™ì€ ë‹¨ìˆœ í˜•ì‹ì¼ ë•Œë§Œ ë³€í™˜
            if (!rowData.deadline.includes('T') && !rowData.deadline.includes('Z')) {
                const localDate = new Date(rowData.deadline.replace(" ", "T"));
                // ìœ íš¨í•œ ë‚ ì§œì¼ ë•Œë§Œ ë³€í™˜
                if (!isNaN(localDate.getTime())) {
                    rowData.deadline = localDate.toISOString();
                }
            }
            // ì´ë¯¸ UTC í˜•ì‹ì´ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
        }

        if (id) {
          // âœ… idê°€ ì¡´ì¬í•˜ë©´ update
          const { error } = await supabase.from("party_cards").update(rowData).eq("id", id);
          if (error) alert(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (id=${id}): ${error.message}`);
        } else {
          // âœ… idê°€ ì—†ìœ¼ë©´ ì‚½ì…, UUIDëŠ” ìë™ ìƒì„±ë˜ë¯€ë¡œ id ì œê±°
          delete rowData.id;
          const { error } = await supabase.from("party_cards").insert([rowData]);
          if (error) alert("âŒ ì¶”ê°€ ì‹¤íŒ¨: " + error.message);
        }
      }

      alert("âœ… ì €ì¥ ì™„ë£Œ!");
      loadData();
    });

    tbody.addEventListener("click", async (e) => {
      const deleteBtn = e.target.closest(".delete-btn");
      if (!deleteBtn) return;

      const tr = deleteBtn.closest("tr");
      const id = tr.dataset.id;

      if (!id) {
        tr.remove();
      } else {
        const ok = confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?");
        if (!ok) return;

        const { error } = await supabase.from("party_cards").delete().eq("id", id);
        if (error) return alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + error.message);
        tr.remove();
      }
    });

    loadData();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
