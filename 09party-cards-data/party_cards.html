<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>파티 카드 관리</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="party_cards.css">
  <link rel="stylesheet" href="../common/sidebar.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="party_cards main-content">
    <div class="table-wrapper container-fluid px-4 mt-5">
      <div class="party_cards-main d-flex flex-column mt-5 mt-md-0 mb-3">
        <h2 class="mb-3 mb-md-3">📋 파티 카드 수정</h2>
        <div class="table-responsive">
          <table id="party-table" class="table table-striped-custom table-table table-borderless table-hover align-middle text-nowrap">
            <thead class="table-header-wrapper">
              <tr>
                <th>순서</th>
                <th>날짜</th>
                <th>시간</th>
                <th>장소</th>
                <th>성비</th>
                <th>마감일시</th>
                <th>폼 URL</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="btn row-buttons">
        <button class="add-row-btn btn">+ 행 추가</button>
        <button id="save-button" class="btn">변경사항 저장</button>
      </div>
    </div>
  </div>
  <script>
    const supabase = window.supabase.createClient(
      "https://wqxmvqqkbxiykiotbusd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk"
    );

    const fields = ["title", "date", "time", "location", "gender", "deadline", "form_url"];
    const tbody = document.querySelector("#party-table tbody");

    function formatDeadline(deadlineStr) {
        if (!deadlineStr || !deadlineStr.includes('T')) {
            // 이미 'YYYY-MM-DD HH:mm' 형식이거나 비어있으면 그대로 반환
            return deadlineStr || "";
        }

        const date = new Date(deadlineStr);
        // getTimezoneOffset()은 분 단위 오프셋을 반환 (KST의 경우 -540)
        // UTC와 KST의 차이는 -540분이므로, UTC 시간에 이 차이를 빼주면 KST가 됩니다.
        const offset = date.getTimezoneOffset() * 60000; // 밀리초 단위로 변환
        const localTime = new Date(date.getTime() - offset);

        // 이제 localTime은 KST 기준 시간을 나타냅니다.
        // 이 시간을 "YYYY-MM-DDTHH:mm:ss.sssZ" 형식으로 바꾸고 필요한 부분만 잘라냅니다.
        const isoString = localTime.toISOString(); // 결과: "2025-08-01T20:00:00.000Z"
        
        // "YYYY-MM-DD HH:mm" 형식으로 최종 반환
        return isoString.substring(0, 16).replace('T', ' ');
    }

    function createRow(row = {}, id = "") {
      const tr = document.createElement("tr");
      tr.dataset.id = id;

      // ✅ 라벨 텍스트와 key를 매핑
      const labels = {
        title: "제목",
        date: "날짜",
        time: "시간",
        location: "장소",
        gender: "성비",
        deadline: "마감일시",
        form_url: "폼 URL"
      };

      fields.forEach(key => {
        const td = document.createElement("td");
        td.dataset.key = key;
        td.setAttribute("data-label", labels[key]); // ✅ 라벨 속성 추가

        const value = key === "deadline" && row[key]
          ? formatDeadline(row[key])
          : (row[key] ?? "");

        td.innerHTML = `<input type="text" class="form-control form-control-sm" value="${value}">`;
        tr.appendChild(td);
      });

      // 삭제 버튼 열
      const deleteTd = document.createElement("td");
      deleteTd.setAttribute("data-label", "삭제"); // ✅ 삭제 버튼도 라벨 추가
      deleteTd.innerHTML = `
        <button class="delete-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg>
        </button>`;
      tr.appendChild(deleteTd);

      tbody.appendChild(tr);

      // ✅ 모바일일 때만 아래로 스크롤
      if (window.innerWidth < 768) {
        setTimeout(() => {
          tr.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 50); // 렌더 타이밍 확보
      }
    }

    async function loadData() {
      const { data, error } = await supabase
        .from("party_cards")
        .select("*")
        .order("date", { ascending: true });

      if (error) return alert("❌ 불러오기 실패: " + error.message);
      tbody.innerHTML = "";
      data.forEach(row => createRow(row, row.id));
    }

    document.querySelector(".add-row-btn").addEventListener("click", () => {
      createRow(); // 빈 행 추가
    });

    document.getElementById("save-button").addEventListener("click", async () => {
      const rows = document.querySelectorAll("tbody tr");

      for (const tr of rows) {
        const id = tr.dataset.id?.trim();  // ✅ 공백 제거도 포함
        const cells = tr.querySelectorAll("td[data-key]");
        const rowData = {};

        cells.forEach(td => {
          const key = td.dataset.key;
          const input = td.querySelector("input");
          rowData[key] = input.value.trim();
        });

        const isEmpty = Object.values(rowData).every(v => v === "");
        if (isEmpty) continue;

        // 마감일시 변환
        if (rowData.deadline) {
            // 입력값에 'T'나 'Z'가 포함되어 있지 않은, 'YYYY-MM-DD HH:mm' 같은 단순 형식일 때만 변환
            if (!rowData.deadline.includes('T') && !rowData.deadline.includes('Z')) {
                const localDate = new Date(rowData.deadline.replace(" ", "T"));
                // 유효한 날짜일 때만 변환
                if (!isNaN(localDate.getTime())) {
                    rowData.deadline = localDate.toISOString();
                }
            }
            // 이미 UTC 형식이면 아무것도 하지 않고 그대로 둡니다.
        }

        if (id) {
          // ✅ id가 존재하면 update
          const { error } = await supabase.from("party_cards").update(rowData).eq("id", id);
          if (error) alert(`❌ 업데이트 실패 (id=${id}): ${error.message}`);
        } else {
          // ✅ id가 없으면 삽입, UUID는 자동 생성되므로 id 제거
          delete rowData.id;
          const { error } = await supabase.from("party_cards").insert([rowData]);
          if (error) alert("❌ 추가 실패: " + error.message);
        }
      }

      alert("✅ 저장 완료!");
      loadData();
    });

    tbody.addEventListener("click", async (e) => {
      const deleteBtn = e.target.closest(".delete-btn");
      if (!deleteBtn) return;

      const tr = deleteBtn.closest("tr");
      const id = tr.dataset.id;

      if (!id) {
        tr.remove();
      } else {
        const ok = confirm("정말 삭제할까요?");
        if (!ok) return;

        const { error } = await supabase.from("party_cards").delete().eq("id", id);
        if (error) return alert("❌ 삭제 실패: " + error.message);
        tr.remove();
      }
    });

    loadData();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
