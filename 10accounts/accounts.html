<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³„ì • ì •ë³´</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="accounts.css">
  <link rel="stylesheet" href="/common/sidebar.css">
</head>
<body>
  <div class="accounts-wrapper main-content">
    <div class="accounts-main container-fluid px-4 mt-5">
      <div class="accounts-start d-flex flex-column mt-5 mt-md-0 mb-3">
        <div class="grl-info-wrapper">
          <h2 class="mb-3 mb-md-3">ğŸ” ê°€ì… ì‚¬ì´íŠ¸ ê³„ì • ì •ë³´</h2>
          <div class="grl-info mb-3 mb-md-3">
            <div class="grl-info-box"><div class="grl-number-account-title">ì—…ë¬´í° ì „í™”ë²ˆí˜¸</div><div class="grl-number-account-text">010-6645-2731</div></div>
            <div class="grl-info-box"><div class="grl-number-account-title">ì‚¬ì—…ìê³„ì¢Œ</div><div class="grl-number-account-text">êµ­ë¯¼ 80750104327992</div></div>
            <div class="grl-info-box"><div class="grl-number-account-title">ì‚¬ì—…ìë²ˆí˜¸</div><div class="grl-number-account-text">736-22-02185</div></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="account-table table table-borderless table-hover align-middle text-center table-striped-custom">
            <thead class="table-dark">
              <tr>
                <th>ì‚¬ì´íŠ¸</th>
                <th>ì•„ì´ë””</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th>ë§ˆì§€ë§‰ ìˆ˜ì •ì¼</th>
                <th>ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody id="account-body">
              <!-- JSì—ì„œ ì±„ì›Œì§ -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="button-wrapper">
        <button class="add-row-btn" onclick="addRow()">+ í–‰ ì¶”ê°€</button>
        <button class="save-button" onclick="saveChanges()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- âœ… JavaScriptëŠ” ë§ˆì§€ë§‰ì— ì‚½ì… -->
  <script>
    // âš ï¸ Supabase ì—°ê²°ì€ ì´ ì•„ë˜ì—ì„œ ì„ ì–¸ë¼ì•¼ í•¨
    const supabaseClient = supabase.createClient('https://wqxmvqqkbxiykiotbusd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk') // ìƒëµ');


    let rowsData = [];
    let newRows = [];
    let editedRows = new Set();

    async function loadData() {
      const { data, error } = await supabaseClient
        .from('accounts')
        .select('*')
        .order('updated_at', { ascending: true });

      if (error) {
        alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
        return;
      }

      rowsData = data;
      newRows = [];
      editedRows.clear();
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('account-body');
      tbody.innerHTML = '';

      rowsData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="ì‚¬ì´íŠ¸"><input type="text" class="form-control site" value="${row.site}" onchange="markEdited(${row.id}, this, 'site')" /></td>
          <td data-label="ì•„ì´ë””"><input type="text" class="form-control id" value="${row.username}" onchange="markEdited(${row.id}, this, 'username')" /></td>
          <td data-label="ë¹„ë°€ë²ˆí˜¸"><input type="text" class="form-control password" value="${row.password}" onchange="markEdited(${row.id}, this, 'password')" /></td>
          <td data-label="ë§ˆì§€ë§‰ ìˆ˜ì •ì¼"><span class="last-edit-date">${row.updated_at ? new Date(row.updated_at).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : ''}</span></td>
          <td data-label="ì‚­ì œ"><button class="btn delete-btn" onclick="deleteRow(${row.id})">            
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg></button></td>
        `;
        tbody.appendChild(tr);
      });

      newRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="ì‚¬ì´íŠ¸"><input type="text" class="form-control site" placeholder="ì‚¬ì´íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" value="${row.site}" oninput="updateNewRow(${index}, 'site', this.value)" /></td>
          <td data-label="ì•„ì´ë””"><input type="text" class="form-control id" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" value="${row.username}" oninput="updateNewRow(${index}, 'username', this.value)" /></td>
          <td data-label="ë¹„ë°€ë²ˆí˜¸"><input type="text" class="form-control password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" value="${row.password}" oninput="updateNewRow(${index}, 'password', this.value)" /></td>
          <td data-label="ë§ˆì§€ë§‰ ìˆ˜ì •ì¼"><span class="last-edit-date">${row.updated_at ? new Date(row.updated_at).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : ''}</span></td>
          <td data-label="ì‚­ì œ"><button class="btn delete-btn" onclick="removeNewRow(${index})">          
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg></button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function markEdited(id, input, field) {
      const row = rowsData.find(r => r.id === id);
      if (row && row[field] !== input.value) {
        row[field] = input.value;
        editedRows.add(id);
      }
    }

    function updateNewRow(index, field, value) {
      newRows[index][field] = value;
    }

    function addRow() {
      newRows.push({ site: '', username: '', password: '' });
      renderTable();

      // âœ… ëª¨ë°”ì¼ í™”ë©´ì—ì„œë§Œ ìë™ ìŠ¤í¬ë¡¤
      if (window.innerWidth < 768) {
        const tbody = document.getElementById('account-body');
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
          lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    
    function removeNewRow(index) {
      newRows.splice(index, 1);
      renderTable();
    }

    async function deleteRow(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await supabaseClient.from('accounts').delete().eq('id', id);
      rowsData = rowsData.filter(row => row.id !== id);
      renderTable();
    }

    async function saveChanges() {
      console.log('editedRows:', editedRows);
      for (const id of editedRows) {
        const row = rowsData.find(r => r.id === id);
        const { error } = await supabaseClient.from('accounts').update({
          site: row.site,
          username: row.username,
          password: row.password,
          updated_at: new Date().toISOString()
        }).eq('id', id);

        if (error) {
          alert(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (id=${id}): ${error.message}`);
          return;
        }
      }

      const validNew = newRows.filter(r => r.site && r.username && r.password);
      if (validNew.length > 0) {
        // âœ… updated_at ì§ì ‘ ì¶”ê°€
        validNew.forEach(row => {
          row.updated_at = new Date().toISOString();
        });

        const { error } = await supabaseClient.from('accounts').insert(validNew);
        if (error) {
          alert("âŒ ì¶”ê°€ ì‹¤íŒ¨: " + error.message);
          return;
        }
      }

      alert("âœ… ì €ì¥ ì™„ë£Œ");
      loadData();
    }

    loadData();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
