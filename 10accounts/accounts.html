<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>계정 정보</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="accounts.css">
  <link rel="stylesheet" href="/common/sidebar.css">
</head>
<body>
  <div class="accounts-wrapper main-content">
    <div class="accounts-main container-fluid px-4 mt-5">
      <div class="accounts-start d-flex flex-column mt-5 mt-md-0 mb-3">
        <div class="grl-info-wrapper">
          <h2 class="mb-3 mb-md-3">🔐 가입 사이트 계정 정보</h2>
          <div class="grl-info mb-3 mb-md-3">
            <div class="grl-info-box"><div class="grl-number-account-title">업무폰 전화번호</div><div class="grl-number-account-text">010-6645-2731</div></div>
            <div class="grl-info-box"><div class="grl-number-account-title">사업자계좌</div><div class="grl-number-account-text">국민 80750104327992</div></div>
            <div class="grl-info-box"><div class="grl-number-account-title">사업자번호</div><div class="grl-number-account-text">736-22-02185</div></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="account-table table table-borderless table-hover align-middle text-center table-striped-custom">
            <thead class="table-dark">
              <tr>
                <th>사이트</th>
                <th>아이디</th>
                <th>비밀번호</th>
                <th>마지막 수정일</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody id="account-body">
              <!-- JS에서 채워짐 -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="button-wrapper">
        <button class="add-row-btn" onclick="addRow()">+ 행 추가</button>
        <button class="save-button" onclick="saveChanges()">💾 저장하기</button>
      </div>
    </div>
  </div>

  <!-- ✅ JavaScript는 마지막에 삽입 -->
  <script>
    // ⚠️ Supabase 연결은 이 아래에서 선언돼야 함
    const supabaseClient = supabase.createClient('https://wqxmvqqkbxiykiotbusd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk') // 생략');


    let rowsData = [];
    let newRows = [];
    let editedRows = new Set();

    async function loadData() {
      const { data, error } = await supabaseClient
        .from('accounts')
        .select('*')
        .order('updated_at', { ascending: true });

      if (error) {
        alert('불러오기 실패: ' + error.message);
        return;
      }

      rowsData = data;
      newRows = [];
      editedRows.clear();
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('account-body');
      tbody.innerHTML = '';

      rowsData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="사이트"><input type="text" class="form-control site" value="${row.site}" onchange="markEdited(${row.id}, this, 'site')" /></td>
          <td data-label="아이디"><input type="text" class="form-control id" value="${row.username}" onchange="markEdited(${row.id}, this, 'username')" /></td>
          <td data-label="비밀번호"><input type="text" class="form-control password" value="${row.password}" onchange="markEdited(${row.id}, this, 'password')" /></td>
          <td data-label="마지막 수정일"><span class="last-edit-date">${row.updated_at ? new Date(row.updated_at).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : ''}</span></td>
          <td data-label="삭제"><button class="btn delete-btn" onclick="deleteRow(${row.id})">            
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg></button></td>
        `;
        tbody.appendChild(tr);
      });

      newRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="사이트"><input type="text" class="form-control site" placeholder="사이트명을 입력해주세요" value="${row.site}" oninput="updateNewRow(${index}, 'site', this.value)" /></td>
          <td data-label="아이디"><input type="text" class="form-control id" placeholder="아이디를 입력해주세요" value="${row.username}" oninput="updateNewRow(${index}, 'username', this.value)" /></td>
          <td data-label="비밀번호"><input type="text" class="form-control password" placeholder="비밀번호를 입력해주세요" value="${row.password}" oninput="updateNewRow(${index}, 'password', this.value)" /></td>
          <td data-label="마지막 수정일"><span class="last-edit-date">${row.updated_at ? new Date(row.updated_at).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' }) : ''}</span></td>
          <td data-label="삭제"><button class="btn delete-btn" onclick="removeNewRow(${index})">          
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-trash2-icon lucide-trash-2">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            <line x1="10" x2="10" y1="11" y2="17"/>
            <line x1="14" x2="14" y1="11" y2="17"/>
          </svg></button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function markEdited(id, input, field) {
      const row = rowsData.find(r => r.id === id);
      if (row && row[field] !== input.value) {
        row[field] = input.value;
        editedRows.add(id);
      }
    }

    function updateNewRow(index, field, value) {
      newRows[index][field] = value;
    }

    function addRow() {
      newRows.push({ site: '', username: '', password: '' });
      renderTable();

      // ✅ 모바일 화면에서만 자동 스크롤
      if (window.innerWidth < 768) {
        const tbody = document.getElementById('account-body');
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
          lastRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    
    function removeNewRow(index) {
      newRows.splice(index, 1);
      renderTable();
    }

    async function deleteRow(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      await supabaseClient.from('accounts').delete().eq('id', id);
      rowsData = rowsData.filter(row => row.id !== id);
      renderTable();
    }

    async function saveChanges() {
      console.log('editedRows:', editedRows);
      for (const id of editedRows) {
        const row = rowsData.find(r => r.id === id);
        const { error } = await supabaseClient.from('accounts').update({
          site: row.site,
          username: row.username,
          password: row.password,
          updated_at: new Date().toISOString()
        }).eq('id', id);

        if (error) {
          alert(`❌ 업데이트 실패 (id=${id}): ${error.message}`);
          return;
        }
      }

      const validNew = newRows.filter(r => r.site && r.username && r.password);
      if (validNew.length > 0) {
        // ✅ updated_at 직접 추가
        validNew.forEach(row => {
          row.updated_at = new Date().toISOString();
        });

        const { error } = await supabaseClient.from('accounts').insert(validNew);
        if (error) {
          alert("❌ 추가 실패: " + error.message);
          return;
        }
      }

      alert("✅ 저장 완료");
      loadData();
    }

    loadData();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
