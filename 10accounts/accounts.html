<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³„ì • ì •ë³´</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="accounts.css">
  <link rel="stylesheet" href="/common/sidebar.css">
</head>
<body>
  <div class="accounts-wrapper">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <div class="sidebar-head">
        <button id="sidebar-toggle">
          <img class="hamburger-icon" src="../assets/hamburger.png">
        </button>
        <a href="../01main/index.html" class="sidebar-head-logo">
          <img class="sidebar-head-loge-img" src="../assets/logo.png">
        </a>
      </div>
      <ul>
        <li class="list-category">
          <span class="list-category-text">MANAGE</span>
        </li>
        <li class="list">
          <a href="../02applylist/applylist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/form.png" class="form-icon">
              </span>
              <span class="list-content-text">íŒŒí‹°ì‹ ì²­ì„œ</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../03reservationlist/reservationlist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/reservationsheet.png" class="form-icon">
              </span>
              <span class="list-content-text">ì˜ˆì•½ì‹œíŠ¸</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../05cardlogs/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/creditcard.png" class="form-icon">
              </span>
              <span class="list-content-text">ì¬ë¬´ê¸°ë¡</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../04calendar/calender.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">ìº˜ë¦°ë”</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../09party-cards-data/party_cards.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">íŒŒí‹°ì¹´ë“œ ë°ì´í„°</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../10accounts/accounts.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">ê²Œë¦´ë¼ ê³„ì •</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list-category">
          <span class="list-category-text">GAMES</span>
        </li>
        <li class="list">
          <a href="../07ppt/controller.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/ppt.png" class="form-icon">
              </span>
              <span class="list-content-text">ì§„í–‰PPT</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
                <li class="list">
          <a href="/11stickgame/controller.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/music.png" class="form-icon">
              </span>
              <span class="list-content-text">ë§‰ëŒ€ê²Œì„</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../06quizppt/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/person.png" class="form-icon">
              </span>
              <span class="list-content-text">ì¸ë¬¼ê²Œì„</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
      </ul>
    </div>
    <div class="accounts-main">
      <h2>ğŸ” ê°€ì… ì‚¬ì´íŠ¸ ê³„ì • ì •ë³´</h2>
      <table class="account-table">
        <thead>
          <tr>
            <th>ì‚¬ì´íŠ¸</th>
            <th>ì•„ì´ë””</th>
            <th>ë¹„ë°€ë²ˆí˜¸</th>
            <th>ë§ˆì§€ë§‰ ìˆ˜ì •ì¼</th>
            <th>ì‚­ì œ</th>
          </tr>
        </thead>
        <tbody id="account-body">
          <!-- JSì—ì„œ ì±„ì›Œì§ -->
        </tbody>
      </table>

      <div class="button-wrapper">
        <button class="add-row-btn" onclick="addRow()">+ í–‰ ì¶”ê°€</button>
        <button class="save-button" onclick="saveChanges()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- âœ… JavaScriptëŠ” ë§ˆì§€ë§‰ì— ì‚½ì… -->
  <script>
    // âš ï¸ Supabase ì—°ê²°ì€ ì´ ì•„ë˜ì—ì„œ ì„ ì–¸ë¼ì•¼ í•¨
    const supabaseClient = supabase.createClient('https://wqxmvqqkbxiykiotbusd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk') // ìƒëµ');


    let rowsData = [];
    let newRows = [];
    let editedRows = new Set();

    async function loadData() {
      const { data, error } = await supabaseClient
        .from('accounts')
        .select('*')
        .order('updated_at', { ascending: true });

      if (error) {
        alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
        return;
      }

      rowsData = data;
      newRows = [];
      editedRows.clear();
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('account-body');
      tbody.innerHTML = '';

      rowsData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${row.site}" onchange="markEdited(${row.id}, this, 'site')" /></td>
          <td><input type="text" value="${row.username}" onchange="markEdited(${row.id}, this, 'username')" /></td>
          <td><input type="text" value="${row.password}" onchange="markEdited(${row.id}, this, 'password')" /></td>
          <td>${new Date(row.updated_at).toLocaleDateString('ko-KR', {
            month: 'long',
            day: 'numeric'
          })}</td>
          <td><button class="btn delete-btn" onclick="deleteRow(${row.id})">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
      });

      newRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" placeholder="ì‚¬ì´íŠ¸" value="${row.site}" oninput="updateNewRow(${index}, 'site', this.value)" /></td>
          <td><input type="text" placeholder="ì•„ì´ë””" value="${row.username}" oninput="updateNewRow(${index}, 'username', this.value)" /></td>
          <td><input type="text" placeholder="ë¹„ë°€ë²ˆí˜¸" value="${row.password}" oninput="updateNewRow(${index}, 'password', this.value)" /></td>
          <td>-</td>
          <td><button class="btn delete-btn" onclick="removeNewRow(${index})">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function markEdited(id, input, field) {
      const row = rowsData.find(r => r.id === id);
      if (row && row[field] !== input.value) {
        row[field] = input.value;
        editedRows.add(id);
      }
    }

    function updateNewRow(index, field, value) {
      newRows[index][field] = value;
    }

    function addRow() {
      newRows.push({ site: '', username: '', password: '' });
      renderTable();
    }

    function removeNewRow(index) {
      newRows.splice(index, 1);
      renderTable();
    }

    async function deleteRow(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await supabaseClient.from('accounts').delete().eq('id', id);
      rowsData = rowsData.filter(row => row.id !== id);
      renderTable();
    }

    async function saveChanges() {
      for (const id of editedRows) {
        const row = rowsData.find(r => r.id === id);
        const { error } = await supabaseClient.from('accounts').update({
          site: row.site,
          username: row.username,
          password: row.password,
          updated_at: new Date().toISOString()
        }).eq('id', id);

        if (error) {
          alert(`âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (id=${id}): ${error.message}`);
          return;
        }
      }

      const validNew = newRows.filter(r => r.site && r.username && r.password);
      if (validNew.length > 0) {
        // âœ… updated_at ì§ì ‘ ì¶”ê°€
        validNew.forEach(row => {
          row.updated_at = new Date().toISOString();
        });

        const { error } = await supabaseClient.from('accounts').insert(validNew);
        if (error) {
          alert("âŒ ì¶”ê°€ ì‹¤íŒ¨: " + error.message);
          return;
        }
      }

      alert("âœ… ì €ì¥ ì™„ë£Œ");
      loadData();
    }

    loadData();
  </script>
  <script src="/common/sidebar.js"></script>
</body>
</html>
