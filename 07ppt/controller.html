<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“‘ PPT ì»¨íŠ¸ë¡¤ëŸ¬</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="../common/sidebar.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body>
  <div class="ppt-main main-content">
    <div class="reservation container-fluid px-4 mt-5">
      <div class="slide-controller-wrapper d-flex flex-column mt-5 mt-md-0 mb-3">
        <h2 class="mb-3 mb-md-3">ğŸ“‘ PPT ìŠ¬ë¼ì´ë“œ ì»¨íŠ¸ë¡¤ëŸ¬</h2>
        <button onclick="startPPT()" class="ppt-start-button"><span class="ppt-start-text">PPT ì‹œì‘í•˜ê¸°</span></button>
        <h3>âœ… ì„ íƒëœ ìŠ¬ë¼ì´ë“œ</h3>
        <div id="selected-slides">
          <div id="drop-indicator"></div>
        </div>
        <div class="slide-list" id="all-sets"></div>
      </div>
    </div>
  </div>

  <script>
    // âœ… 1. displayWindowëŠ” ì „ì—­ ë³€ìˆ˜ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
    let displayWindow = null;
    const selectedSlides = [];
    const slideItemsMap = {};

    // âœ… 2. startPPT í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
    function startPPT() {
      if (!selectedSlides.length) return alert("ì„ íƒëœ ìŠ¬ë¼ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");

      // ì´ë¯¸ ì°½ì´ ì—´ë ¤ìˆê³  ë‹«íˆì§€ ì•Šì•˜ë‹¤ë©´,
      if (displayWindow && !displayWindow.closed) {
        displayWindow.focus(); // ì°½ì„ ì•ìœ¼ë¡œ ê°€ì ¸ì˜¤ê³ 
        // ì´ë¯¸ ì¤€ë¹„ëœ ì°½ì´ë¯€ë¡œ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ë³´ëƒ…ë‹ˆë‹¤.
        displayWindow.postMessage({ type: "slides", slides: selectedSlides }, "*");
      } else {
        // ìƒˆ ì°½ì„ ì—½ë‹ˆë‹¤. ë°ì´í„°ëŠ” ì•„ì§ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.
        displayWindow = window.open("display.html", "display_slides", "width=1000,height=700");
      }
      // ê¸°ì¡´ì˜ setTimeout ë¡œì§ì€ ì œê±°ë©ë‹ˆë‹¤.
    }
    
    // âœ… 3. 'display_ready' ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    window.addEventListener('message', function(event) {
      // display.htmlë¡œë¶€í„° "ì¤€ë¹„ ì™„ë£Œ" ì‹ í˜¸ê°€ ì™”ëŠ”ì§€ í™•ì¸
      if (event.data && event.data.type === 'display_ready') {
        console.log("Display í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ! ìŠ¬ë¼ì´ë“œ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.");
        
        // displayWindowê°€ ìœ íš¨í•˜ê³ , ë³´ë‚¼ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ ì „ì†¡
        if (displayWindow && !displayWindow.closed && selectedSlides.length > 0) {
          displayWindow.postMessage({ type: "slides", slides: selectedSlides }, "*");
        }
      }
    });


    // --- ì•„ë˜ì˜ ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ì€ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤ ---

    function makeSlideItem(src, labelText) {
      const li = document.createElement("li");
      li.className = "slide-item";

      const img = document.createElement("img");
      img.src = src;

      const label = document.createElement("div");
      label.className = "slide-label";
      label.textContent = labelText.replace(/\.[^/.]+$/, "");

      li.appendChild(img);
      li.appendChild(label);

      li.onclick = () => {
        const index = selectedSlides.indexOf(src);
        if (index !== -1) {
          selectedSlides.splice(index, 1);
          li.classList.remove("selected");
        } else {
          selectedSlides.push(src);
          li.classList.add("selected");
        }
        renderSelectedSlides();
      };

      slideItemsMap[src] = li;
      return li;
    }

    function addToSelected(src) {
      if (!selectedSlides.includes(src)) {
        selectedSlides.push(src);
        slideItemsMap[src]?.classList.add("selected");
        renderSelectedSlides();
      }
    }

    function renderSelectedSlides() {
      const container = document.getElementById("selected-slides");
      // âœ… ì¸ë””ì¼€ì´í„°ë¥¼ ì œì™¸í•œ ê¸°ì¡´ ì¸ë„¤ì¼ë“¤ë§Œ ë¨¼ì € ì‚­ì œ
      container.querySelectorAll('.slide-thumb').forEach(thumb => thumb.remove());

      const dropIndicator = document.getElementById('drop-indicator');

      selectedSlides.forEach((src, index) => {
        const div = document.createElement("div");
        div.className = "slide-thumb";
        div.draggable = true;

        // ... img, btn ìƒì„± ë° ì¶”ê°€ ë¡œì§ (ì´ì „ê³¼ ë™ì¼) ...
        const img = document.createElement("img");
        img.src = src;
        const btn = document.createElement("button");
        btn.textContent = "x";
        btn.className = "remove-btn";
        btn.onclick = (e) => {
          e.stopPropagation();
          selectedSlides.splice(index, 1);
          if (slideItemsMap[src]) {
            slideItemsMap[src].classList.remove("selected");
          }
          renderSelectedSlides();
        };
        div.appendChild(img);
        div.appendChild(btn);
        // ... img, btn ë¡œì§ ë ...
        
        // --- âœ… ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì „ì²´ ìˆ˜ì • ---
        div.ondragstart = (e) => {
          e.dataTransfer.setData("index", index);
          setTimeout(() => div.classList.add("dragging"), 0);
        };

        div.ondragend = () => {
          div.classList.remove("dragging");
          // ë“œë˜ê·¸ê°€ ëë‚˜ë©´ ì¸ë””ì¼€ì´í„°ë¥¼ ë¬´ì¡°ê±´ ìˆ¨ê¹€
          dropIndicator.style.display = 'none';
        };

        div.ondragover = (e) => {
          e.preventDefault();
          // ì¸ë””ì¼€ì´í„°ë¥¼ ë³´ì—¬ì¤Œ
          dropIndicator.style.display = 'block';

          // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê³„ì‚°
          const rect = div.getBoundingClientRect();
          const midX = rect.left + rect.width / 2;

          // ì¸ë””ì¼€ì´í„°ì˜ ë†’ì´ì™€ ì„¸ë¡œ ìœ„ì¹˜ ì„¤ì •
          dropIndicator.style.height = `${div.offsetHeight}px`;
          dropIndicator.style.top = `${div.offsetTop}px`;
          
          // ë§ˆìš°ìŠ¤ê°€ ì™¼ìª½ ì ˆë°˜ì— ìˆìœ¼ë©´ ìš”ì†Œì˜ ì™¼ìª½ì—, ì•„ë‹ˆë©´ ì˜¤ë¥¸ìª½ì— ë¼ì¸ í‘œì‹œ
          if (e.clientX < midX) {
            dropIndicator.style.left = `${div.offsetLeft - 2}px`; // -2ëŠ” ë¼ì¸ ë‘ê»˜ì˜ ì ˆë°˜
          } else {
            dropIndicator.style.left = `${div.offsetLeft + div.offsetWidth - 2}px`;
          }
        };

        div.ondrop = (e) => {
          e.preventDefault();
          // ë“œë¡­ í›„ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
          dropIndicator.style.display = 'none';

          const fromIndex = parseInt(e.dataTransfer.getData("index"), 10);
          let toIndex = index;

          // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•˜ì—¬ ìµœì¢… ë“œë¡­ ìœ„ì¹˜ ê²°ì •
          const rect = div.getBoundingClientRect();
          const midX = rect.left + rect.width / 2;
          
          // ë§ˆìš°ìŠ¤ê°€ ì˜¤ë¥¸ìª½ ì ˆë°˜ì— ë“œë¡­ë˜ì—ˆë‹¤ë©´, ì‚½ì… ìœ„ì¹˜ëŠ” í•´ë‹¹ ìš”ì†Œì˜ 'ë‹¤ìŒ'
          if (e.clientX > midX) {
            toIndex++;
          }
          
          if (fromIndex === toIndex) return;

          const movedItem = selectedSlides.splice(fromIndex, 1)[0];
          if (fromIndex < toIndex) {
            toIndex--;
          }
          selectedSlides.splice(toIndex, 0, movedItem);
          renderSelectedSlides();
        };

        // containerì— ìì‹ìœ¼ë¡œ ì¶”ê°€í•  ë•Œ, ì¸ë””ì¼€ì´í„°ë³´ë‹¤ ì•ì— ì¶”ê°€
        container.appendChild(div);
      });
    }

    fetch("slides.json")
          .then(res => res.json())
          .then(data => {
            const container = document.getElementById("all-sets");

            Object.entries(data).forEach(([group, content]) => {
              
              // âœ… 1. h3 ì œëª©ì„ ë¨¼ì € ìƒì„±í•´ì„œ ë©”ì¸ ì»¨í…Œì´ë„ˆ('all-sets')ì— ë°”ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
              const groupTitle = document.createElement("h3");
              groupTitle.className = "slide-group-title";
              groupTitle.textContent = group;
              container.appendChild(groupTitle);

              // âœ… 2. h3ì„ ì œì™¸í•œ 'ì½˜í…ì¸ ë§Œ'ì„ ë‹´ì„ Wrapper divë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
              const groupWrapper = document.createElement("div");
              const safeClassName = group.replace(/\s+/g, '-');
              groupWrapper.className = "slide-group-container";
              groupWrapper.classList.add(`group-${safeClassName}`);

              // --- ì´ì œë¶€í„° h4, ul ë“±ì˜ ì½˜í…ì¸ ëŠ” ëª¨ë‘ ì´ groupWrapperì— ì¶”ê°€ë©ë‹ˆë‹¤. ---
              
              if (Array.isArray(content)) {
                const ul = document.createElement("ul");
                content.forEach(file => {
                  const fullPath = `ppt-slides/${group}/${file}`;
                  ul.appendChild(makeSlideItem(fullPath, file));
                });
                groupWrapper.appendChild(ul);
              } 
              else if (typeof content === 'object' && content !== null) {
                Object.entries(content).forEach(([subName, files]) => {
                  if(Array.isArray(files)) {
                    const subTitle = document.createElement("h4");
                    subTitle.className = "slide-subgroup-title";
                    subTitle.textContent = subName;
                    groupWrapper.appendChild(subTitle);
                    
                    const ul = document.createElement("ul");
                    files.forEach(file => {
                      const fullPath = `ppt-slides/${group}/${subName}/${file}`;
                      ul.appendChild(makeSlideItem(fullPath, file));
                    });
                    groupWrapper.appendChild(ul);
                  }
                  else {
                    const ul = document.createElement("ul");
                    const fullPath = `ppt-slides/${group}/${subName}`;
                    ul.appendChild(makeSlideItem(fullPath, subName));
                    groupWrapper.appendChild(ul);
                  }
                });
              }
              
              // âœ… 3. ì½˜í…ì¸ ê°€ ëª¨ë‘ ì±„ì›Œì§„ Wrapper divë¥¼ ë©”ì¸ ì»¨í…Œì´ë„ˆì— ì¶”ê°€í•©ë‹ˆë‹¤.
              container.appendChild(groupWrapper);
            });
          });
    
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
