<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ïπ¥Îìú Í≤∞Ï†ú ÎÇ¥Ïó≠</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="../common/sidebar.css" />

</head>
<body>
  <div class="cardlogs-main">
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <div class="sidebar">
      <div class="sidebar-head">
        <button id="sidebar-toggle">
          <img class="hamburger-icon" src="../assets/hamburger.png">
        </button>
        <a href="../01main/index.html" class="sidebar-head-logo">
          <img class="sidebar-head-loge-img" src="../assets/logo.png">
        </a>
      </div>
      <ul>
        <li class="list-category">
          <span class="list-category-text">MANAGE</span>
        </li>
        <li class="list">
          <a href="../02applylist/applylist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/form.png" class="form-icon">
              </span>
              <span class="list-content-text">ÌååÌã∞Ïã†Ï≤≠ÏÑú</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../03reservationlist/reservationlist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/reservationsheet.png" class="form-icon">
              </span>
              <span class="list-content-text">ÏòàÏïΩÏãúÌä∏</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../05cardlogs/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/creditcard.png" class="form-icon">
              </span>
              <span class="list-content-text">Ïû¨Î¨¥Í∏∞Î°ù</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../04calendar/calender.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">Ï∫òÎ¶∞Îçî</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../09party-cards-data/party_cards.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">ÌååÌã∞Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../10accounts/accounts.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">Í≤åÎ¶¥Îùº Í≥ÑÏ†ï</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list-category">
          <span class="list-category-text">GAMES</span>
        </li>
        <li class="list">
          <a href="../07ppt/controller.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/ppt.png" class="form-icon">
              </span>
              <span class="list-content-text">ÏßÑÌñâPPT</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
                <li class="list">
          <a href="/11stickgame/controller.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/stick.png" class="form-icon">
              </span>
              <span class="list-content-text">ÎßâÎåÄÍ≤åÏûÑ</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../06quizppt/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../assets/person.png" class="form-icon">
              </span>
              <span class="list-content-text">Ïù∏Î¨ºÍ≤åÏûÑ</span>
            </span>
            <span class="list-content-arrow">
              <img src="../assets/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
      </ul>
    </div>
    <div class="table-wrapper">
      <h2>üí≥ Ïπ¥Îìú Í≤∞Ï†ú ÎÇ¥Ïó≠</h2>
      <table id="log-table">
        <thead>
          <tr>
            <th>ÏãúÍ∞Ñ</th>
            <th>Ïπ¥ÌÖåÍ≥†Î¶¨</th>
            <th>Í∏àÏï°</th>
            <th>Ïπ¥Îìú</th>
            <th>Ï¢ÖÎ•ò</th>
            <th>ÏûîÏï°</th>
            <th>Í≤∞Ï†úÏ≤ò</th>
            <th>Î©îÎ™®</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // ‚úÖ Î≥ÄÏàòÎ™Ö Ïù¥Î¶Ñ Ï∂©Îèå Î∞©ÏßÄ
    const supa = window.supabase.createClient(
      'https://wqxmvqqkbxiykiotbusd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk'
    );

    const categories = ['Í¥ëÍ≥†', 'Ïû•ÏÜå ÎåÄÍ¥Ä', 'ÏïàÏ£º/Ï£ºÎ•ò', 'ÎπÑÌíà', 'ÏóÖÎ¨¥Ï∂îÏßÑÎπÑ', 'Í≥µÍ≥ºÍ∏à', 'ÌååÌã∞ÎπÑ', 'Í∏∞ÌÉÄ'];

    async function loadInitialLogs() {
      const { data, error } = await supa
        .from('card_logs')
        .select('*')
        .order('timeline', { ascending: false });

      if (error) {
        console.error('Ï¥àÍ∏∞ Î°úÎìú Ïò§Î•ò:', error);
        return;
      }

      const tbody = document.querySelector('#log-table tbody');
      tbody.innerHTML = ''; // Ï¥àÍ∏∞ Î°úÎî© Ïãú Ï†ÑÏ≤¥ Ï±ÑÏö∞Í∏∞

      data.reverse().forEach(row => {
        appendRow(row);
      });
      console.log('Î∂àÎü¨Ïò® timeline ÏàúÏÑú ÌôïÏù∏ ‚Üì');
      data.forEach(row => console.log(row.timeline));
    }

    function formatNumber(num) {
      return typeof num === 'number' ? num.toLocaleString('ko-KR') : '';
    } 

    function formatDateCompact(dateString) {
      const date = new Date(dateString); // ISO ÌòïÏãù ‚Üí Date Í∞ùÏ≤¥
      const MM = String(date.getUTCMonth() + 1).padStart(2, '0');
      const DD = String(date.getUTCDate()).padStart(2, '0');
      const hh = String(date.getUTCHours()).padStart(2, '0');
      const mm = String(date.getUTCMinutes()).padStart(2, '0');
      return `${MM}/${DD} ${hh}:${mm}`;
    }



    function appendRow(row) {
      const tbody = document.querySelector('#log-table tbody');
      const tr = document.createElement('tr');

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÎìúÎ°≠Îã§Ïö¥
      const categoryOptions = categories.map(cat =>
        `<option value="${cat}" ${row.category === cat ? 'selected' : ''}>${cat}</option>`
      ).join('');
            //Ï∂úÍ∏à ÌÉÄÏûÖ ÎìúÎ°≠Îã§Ïö¥
      const typeOptions = ['Ï∂úÍ∏à', 'ÏûÖÍ∏à', 'Ï∂úÍ∏àÏ∑®ÏÜå', 'Í∏∞ÌÉÄ'].map(type =>
        `<option value="${type}" ${row.type === type ? 'selected' : ''}>${type}</option>`
      ).join('');

      let typeClass = '';
      if (row.type === 'ÏûÖÍ∏à') typeClass = 'deposit';
      else if (row.type === 'Ï∂úÍ∏à') typeClass = 'withdrawal';
      else if (row.type === 'Ï∂úÍ∏àÏ∑®ÏÜå') typeClass = 'cancel';
      else typeClass = 'other';

      tr.innerHTML = `
        <td>${formatDateCompact(row.timeline)}</td>
        <td>
          <select class="category-select" data-id="${row.id}" onchange="updateCategory(this)">
            <option value="" hidden></option>
            ${categoryOptions}
          </select>
        </td>
        <td>${formatNumber(row.amount)}</td>
        <td>${row.card}</td>
        <td>  
          <select class="type-select ${typeClass}" data-id="${row.id}" onchange="updateType(this)">
            <option value="" hidden></option>
            ${typeOptions}
          </select>
        </td>
        <td>${formatNumber(row.balance)}</td>
        <td>${row.store}</td>
        <td>
          <input type="text" class="memo-input" value="${row.memo || ''}" 
            data-id="${row.id}" onblur="updateMemo(this)" />
        </td>
      `;
      tbody.prepend(tr); // üÜï Îß® ÏúÑÏóê Ï∂îÍ∞Ä!
    }

    async function updateCategory(selectEl) {
      const newCategory = selectEl.value;
      const id = selectEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ category: newCategory })
        .eq('id', id);

      if (error) {
        alert('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
        console.error(error);
      } else {
        console.log(`‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newCategory}`);
      }
    }

    async function updateType(selectEl) {
      const newType = selectEl.value;
      const id = selectEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ type: newType })
        .eq('id', id);

      if (error) {
        alert('Ï¢ÖÎ•ò ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
        console.error(error);
      } else {
        console.log(`‚úÖ Ï¢ÖÎ•ò ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newType}`);
      }
    }

    async function updateMemo(inputEl) {
      const newMemo = inputEl.value;
      const id = inputEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ memo: newMemo })
        .eq('id', id);

      if (error) {
        alert('Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
        console.error(error);
      } else {
        console.log(`‚úÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newMemo}`);
      }
    }


    // ‚úÖ ÏµúÏ¥à Ï†ÑÏ≤¥ Î°úÎî©
    loadInitialLogs();

    // ‚úÖ Ïã§ÏãúÍ∞Ñ ÏÇΩÏûÖÎßå Í∞êÏßÄ
    supa
      .channel('realtime:card_logs')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'card_logs' },
        payload => {
          console.log('üÜï ÏÉà Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄÎê®:', payload.new);
          appendRow(payload.new); // ‚úÖ ÏÉàÎ°úÏö¥ ÌñâÎßå Ï∂îÍ∞Ä
        }
      )
      .subscribe();
  </script>
  <script src="/common/sidebar.js"></script>

</body>
</html>
