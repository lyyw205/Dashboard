<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Ïπ¥Îìú Í≤∞Ï†ú ÎÇ¥Ïó≠</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="../.common/sidebar.css" />

</head>
<body>
  <div class="cardlogs-main">
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <div class="sidebar">
      <div class="sidebar-head">
        <a href="index.html" class="sidebar-head-logo">
          <img class="sidebar-head-loge-img" src="../.asset/img/logo.png">
        </a>
      </div>
      <ul>
        <li class="list">
          <a href="../02applylist/applylist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="../.asset/img/form.png" class="form-icon">
              </span>
              <span class="list-content-text">ÌååÌã∞Ïã†Ï≤≠ÏÑú</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../03reservationlist/reservationlist.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/reservationsheet.png" class="form-icon">
              </span>
              <span class="list-content-text">ÏòàÏïΩÏãúÌä∏</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/music.png" class="form-icon">
              </span>
              <span class="list-content-text">ÎÖ∏ÎûòÏ¥àÏÑ±</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../06quizppt/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/person.png" class="form-icon">
              </span>
              <span class="list-content-text">Ïù∏Î¨ºÍ≤åÏûÑ</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="#overview" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/ppt.png" class="form-icon">
              </span>
              <span class="list-content-text">ÏßÑÌñâPPT</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../04calendar/calender.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/calendar.png" class="form-icon">
              </span>
              <span class="list-content-text">Ï∫òÎ¶∞Îçî</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
        <li class="list">
          <a href="../05cardlogs/index.html" class="list-content">
            <span class="list-content-leftwrap">
              <span class="list-content-icon">
                <img src="/.asset/img/creditcard.png" class="form-icon">
              </span>
              <span class="list-content-text">Ïû¨Î¨¥Í∏∞Î°ù</span>
            </span>
            <span class="list-content-arrow">
              <img src="/.asset/img/arrow-right.png" class="arrow-right-icon">
            </span>
          </a>
        </li>
      </ul>
    </div>
    <div class="table-wrapper">
      <h2>üí≥ Ïπ¥Îìú Í≤∞Ï†ú ÎÇ¥Ïó≠</h2>
      <table id="log-table">
        <thead>
          <tr>
            <th>ÏãúÍ∞Ñ</th>
            <th>Ïπ¥ÌÖåÍ≥†Î¶¨</th>
            <th>Í∏àÏï°</th>
            <th>Ïπ¥Îìú</th>
            <th>Ï¢ÖÎ•ò</th>
            <th>ÏûîÏï°</th>
            <th>Í≤∞Ï†úÏ≤ò</th>
            <th>Î©îÎ™®</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // ‚úÖ Î≥ÄÏàòÎ™Ö Ïù¥Î¶Ñ Ï∂©Îèå Î∞©ÏßÄ
    const supa = window.supabase.createClient(
      'https://wqxmvqqkbxiykiotbusd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk'
    );

    const categories = ['Í¥ëÍ≥†', 'Ïû•ÏÜå ÎåÄÍ¥Ä', 'ÏïàÏ£º/Ï£ºÎ•ò', 'ÎπÑÌíà', 'ÏóÖÎ¨¥Ï∂îÏßÑÎπÑ', 'Í≥µÍ≥ºÍ∏à', 'ÌååÌã∞ÎπÑ', 'Í∏∞ÌÉÄ'];

    async function loadInitialLogs() {
      const { data, error } = await supa
        .from('card_logs')
        .select('*')
        .order('timeline', { ascending: false });

      if (error) {
        console.error('Ï¥àÍ∏∞ Î°úÎìú Ïò§Î•ò:', error);
        return;
      }

      const tbody = document.querySelector('#log-table tbody');
      tbody.innerHTML = ''; // Ï¥àÍ∏∞ Î°úÎî© Ïãú Ï†ÑÏ≤¥ Ï±ÑÏö∞Í∏∞

      data.forEach(row => {
        appendRow(row);
      });
    }

    function formatNumber(num) {
      return typeof num === 'number' ? num.toLocaleString('ko-KR') : '';
    } 

    function formatDateCompact(dateString) {
      const date = new Date(dateString);
      const MM = String(date.getMonth() + 1).padStart(2, '0');
      const DD = String(date.getDate()).padStart(2, '0');
      const hh = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      return `${MM}/${DD} ${hh}:${mm}`;
    }



    function appendRow(row) {
      const tbody = document.querySelector('#log-table tbody');
      const tr = document.createElement('tr');

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÎìúÎ°≠Îã§Ïö¥
      const categoryOptions = categories.map(cat =>
        `<option value="${cat}" ${row.category === cat ? 'selected' : ''}>${cat}</option>`
      ).join('');

      tr.innerHTML = `
        <td>${formatDateCompact(row.timeline)}</td>
        <td>
          <select class="category-select" data-id="${row.id}" onchange="updateCategory(this)">
            <option value="" hidden></option>
            ${categoryOptions}
          </select>
        </td>
        <td>${formatNumber(row.amount)}</td>
        <td>${row.card}</td>
        <td>${row.type}</td>
        <td>${formatNumber(row.balance)}</td>
        <td>${row.store}</td>
        <td>
          <input type="text" class="memo-input" value="${row.memo || ''}" 
            data-id="${row.id}" onblur="updateMemo(this)" />
        </td>
      `;
      tbody.prepend(tr); // üÜï Îß® ÏúÑÏóê Ï∂îÍ∞Ä!
    }

    async function updateCategory(selectEl) {
      const newCategory = selectEl.value;
      const id = selectEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ category: newCategory })
        .eq('id', id);

      if (error) {
        alert('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
        console.error(error);
      } else {
        console.log(`‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newCategory}`);
      }
    }

    async function updateMemo(inputEl) {
      const newMemo = inputEl.value;
      const id = inputEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ memo: newMemo })
        .eq('id', id);

      if (error) {
        alert('Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
        console.error(error);
      } else {
        console.log(`‚úÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${newMemo}`);
      }
    }


    // ‚úÖ ÏµúÏ¥à Ï†ÑÏ≤¥ Î°úÎî©
    loadInitialLogs();

    // ‚úÖ Ïã§ÏãúÍ∞Ñ ÏÇΩÏûÖÎßå Í∞êÏßÄ
    supa
      .channel('realtime:card_logs')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'card_logs' },
        payload => {
          console.log('üÜï ÏÉà Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄÎê®:', payload.new);
          appendRow(payload.new); // ‚úÖ ÏÉàÎ°úÏö¥ ÌñâÎßå Ï∂îÍ∞Ä
        }
      )
      .subscribe();
  </script>

</body>
</html>
