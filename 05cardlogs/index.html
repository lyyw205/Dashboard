<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¹´ë“œ ê²°ì œ ë‚´ì—­</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="../common/sidebar.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
</head>
<body>
  <div class="cardlogs-main main-content">
    <div class="reservation container-fluid px-4 mt-5">
            <!-- NEW! í•„í„° ë° ì°¨íŠ¸ ì˜ì—­ -->
      <div class="filter-wrapper mt-5 mb-4">
        <h2 class="mb-3">ğŸ“Š í•„í„°ë§ ë°ì´í„° ì¶”ì¶œ</h2>
        <div class="filter-section mb-3">
          <div class="row g-3 align-items-end">
            <!-- ë‚ ì§œ ë²”ìœ„ ì„ íƒ -->
            <div class="col-md-2">
              <label for="startDate" class="form-label"><b>ì‹œì‘ì¼</b></label>
              <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-2">
              <label for="endDate" class="form-label"><b>ì¢…ë£Œì¼</b></label>
              <input type="date" id="endDate" class="form-control">
            </div>
            <!-- ì¢…ë¥˜ ì„ íƒ ë²„íŠ¼ (ì…ê¸ˆ/ì¶œê¸ˆ) -->
            <div class="col-md-2 w-auto">
              <label class="form-label d-block"><b>ì…/ì¶œê¸ˆ</b></label>
              <div id="type-buttons-container" class="d-flex flex-wrap gap-2">
                  <button class="btn type-btn active" data-type="ì¶œê¸ˆ">ì¶œê¸ˆ</button>
                  <button class="btn type-btn" data-type="ì…ê¸ˆ">ì…ê¸ˆ</button>
              </div>
            </div>
            <!-- ë©”ëª¨ ì¸í’‹ -->
            <div class="memo-filter-wrapper col-md-4">
              <label for="memo-search-input" class="form-label"><strong>ğŸ“ ë©”ëª¨ ë‚´ìš©ì„ í¬í•¨í•˜ëŠ” í•­ëª© ê²€ìƒ‰</strong></label>
              <input type="text" id="memo-search-input" class="form-control" placeholder="ê²€ìƒ‰í•  ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">
            </div>
          </div>
          <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë²„íŠ¼ -->
          <div class="mt-3">
            <label class="form-label d-block"><b>ì¹´í…Œê³ ë¦¬ (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</b></label>
            <div id="category-buttons-container" class="d-flex flex-wrap gap-2">
              <!-- JSë¡œ ë²„íŠ¼ ë™ì  ìƒì„± -->
            </div>
          </div>
                    <!-- ì¡°íšŒ ë²„íŠ¼ -->
          <div class="col-md-3 mt-3">
            <button id="filter-btn" class="btn btn-search w-100">ì¡°íšŒí•˜ê¸°</button>
          </div>
        </div>
        <div id="summary-container" class="summary-container mt-4 p-3 border rounded bg-light" style="display: none;">
          <h4>ğŸ” ì¡°íšŒ ê²°ê³¼ ìš”ì•½</h4>
          <div class="row">
            <div class="col-6">
              <p class="summary-label">ì´ ì…ê¸ˆì•¡</p>
              <p id="total-deposit" class="summary-value deposit-color">0 ì›</p>
            </div>
            <div class="col-6">
              <p class="summary-label">ì´ ì¶œê¸ˆì•¡</p>
              <p id="total-withdrawal" class="summary-value withdrawal-color">0 ì›</p>
            </div>
          </div>
        </div>
        
        <!-- ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
        <div id="chart-container">
          <canvas id="category-chart"></canvas>
        </div>
      </div>
      <div class="table-wrapper d-flex flex-column mt-5 mb-3">
        <h2 class="mb-3 mb-md-3">ğŸ’³ì¹´ë“œ ê²°ì œ ë‚´ì—­</h2>
        <div class="p-3 mb-3 border rounded bg-light">
          <div class="row g-3">
            <!-- ë‚ ì§œ í•„í„° -->
            <div class="col-md-2">
              <label for="table-start-date" class="form-label"><strong> ì‹œì‘ì¼</strong></label>
              <input type="date" id="table-start-date" class="form-control">
            </div>
            <div class="col-md-2">
              <label for="table-end-date" class="form-label"><strong> ì¢…ë£Œì¼</strong></label>
              <input type="date" id="table-end-date" class="form-control">
            </div>
            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <div class="mb-3 col-md-2">
              <label for="table-category-filter" class="form-label"><strong> ì¹´í…Œê³ ë¦¬</strong></label>
              <select id="table-category-filter" class="form-select">
                <option value="all">-- ì „ì²´ ë³´ê¸° --</option>
                <!-- ì¹´í…Œê³ ë¦¬ëŠ” JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
              </select>
            </div>
                <!-- ì¢…ë¥˜ í•„í„° -->
            <div class="col-md-2">
              <label for="table-type-filter" class="form-label"><strong> ì¢…ë¥˜</strong></label>
              <select id="table-type-filter" class="form-select">
                <option value="all">-- ì „ì²´ --</option>
                <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
                <option value="ì…ê¸ˆ">ì…ê¸ˆ</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="table-store-search" class="form-label"><strong> ê²°ì œì²˜ ê²€ìƒ‰</strong></label>
              <input type="text" id="table-store-search" class="form-control" placeholder="ê²°ì œì²˜ëª… ì…ë ¥">
            </div>
            <div class="col-md-2">
              <label for="table-memo-search" class="form-label"><strong> ë©”ëª¨ ê²€ìƒ‰</strong></label>
              <input type="text" id="table-memo-search" class="form-control" placeholder="ë©”ëª¨ ë‚´ìš© ì…ë ¥">
            </div>
          </div>
        </div>
        
        <div class="table-responsive">
          <table id="log-table" class="log-table table table-borderless table-hover align-middle text-center table-striped-custom">
            <thead class="table-dark">
              <tr>
                <th>ì‹œê°„</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ê¸ˆì•¡</th>
                <th>ì¹´ë“œ</th>
                <th>ì¢…ë¥˜</th>
                <th>ì”ì•¡</th>
                <th>ê²°ì œì²˜</th>
                <th>ë©”ëª¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // âœ… ë³€ìˆ˜ëª… ì´ë¦„ ì¶©ëŒ ë°©ì§€
    const supa = window.supabase.createClient(
      'https://wqxmvqqkbxiykiotbusd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeG12cXFrYnhpeWtpb3RidXNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcyOTYsImV4cCI6MjA2NDAyMzI5Nn0.RmB92YtjLPMx4tkQibuRVT_T4DL3_O8Pny3ZA9DU0tk'
    );
    Chart.register(ChartDataLabels);

    const categories = ['ê´‘ê³ ', 'ì¥ì†Œ ëŒ€ê´€', 'ì•ˆì£¼/ì£¼ë¥˜', 'ë¹„í’ˆ', 'ì—…ë¬´ì¶”ì§„ë¹„', 'ê³µê³¼ê¸ˆ', 'íŒŒí‹°ë¹„', 'í˜„ì¥íŒë§¤', 'ëŒ€ê´€', 'ê¸°íƒ€'];

    //=======================================================
    // ì°¨íŠ¸ ë° í•„í„°ë§ ê´€ë ¨ ë¡œì§
    //=======================================================
    const typeButtonsContainer = document.getElementById('type-buttons-container');
    const categoryButtonsContainer = document.getElementById('category-buttons-container');
    const filterBtn = document.getElementById('filter-btn');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    let categoryChart = null; 
    const memoSearchInput = document.getElementById('memo-search-input');
    const tableStartDate = document.getElementById('table-start-date');
    const tableEndDate = document.getElementById('table-end-date');
    const tableTypeFilter = document.getElementById('table-type-filter');
    const tableCategoryFilter = document.getElementById('table-category-filter');
    const tableMemoSearch = document.getElementById('table-memo-search');
    const tableStoreSearch = document.getElementById('table-store-search');

    function formatDateForInput(input) {
      // 1. ì…ë ¥ê°’ì´ ì—†ëŠ” ê²½ìš°, ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
      if (!input) return '';

      // 2. ì…ë ¥ê°’ì´ Date ê°ì²´ì¸ ê²½ìš° (setDefaultDateRangeì—ì„œ í˜¸ì¶œë  ë•Œ)
      if (input instanceof Date) {
        // toISOString()ì„ ì‚¬ìš©í•˜ë©´ 'YYYY-MM-DDTHH:...' í˜•ì‹ì´ ë˜ë¯€ë¡œ,
        // ì• 10ìë¦¬ë¥¼ ì˜ë¼ 'YYYY-MM-DD'ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.
        return input.toISOString().slice(0, 10);
      }

      // 3. ì…ë ¥ê°’ì´ ë¬¸ìì—´ì¸ ê²½ìš° (applyTableFiltersì—ì„œ í˜¸ì¶œë  ë•Œ)
      if (typeof input === 'string' && input.length >= 10) {
        // ë¬¸ìì—´ì˜ ì• 10ìë¦¬ë¥¼ ì˜ë¼ 'YYYY-MM-DD'ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
        return input.substring(0, 10);
      }
      
      // 4. ê·¸ ì™¸ì˜ ëª¨ë“  ì˜ˆì™¸ì ì¸ ê²½ìš°
      return '';
    }

    // [ì‹ ê·œ] ê¸°ë³¸ ë‚ ì§œ ë²”ìœ„(ì˜¤ëŠ˜ ~ 2ì£¼ ì „)ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function setDefaultDateRange() {
      const today = new Date();
      const twoWeeksAgo = new Date();
      twoWeeksAgo.setDate(today.getDate() - 14);

      endDateInput.value = formatDateForInput(today);
      startDateInput.value = formatDateForInput(twoWeeksAgo);
    }

    function createCategoryButtons() {
      categories.forEach(cat => {
        const button = document.createElement('button');
        button.className = 'btn btn-category category-btn'; // Use secondary for non-active
        button.textContent = cat;
        button.dataset.category = cat;
        categoryButtonsContainer.appendChild(button);
      });
    }
    
    typeButtonsContainer.addEventListener('click', (e) => {
      if (e.target.classList.contains('type-btn')) {
        // í´ë¦­ëœ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ë¥¼ ë‹¨ìˆœíˆ í† ê¸€(toggle)ë§Œ í•©ë‹ˆë‹¤.
        e.target.classList.toggle('active');
      }
    });

    categoryButtonsContainer.addEventListener('click', (e) => {
      // ë²„íŠ¼ì´ 'category-btn' í´ë˜ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
      if (e.target.classList.contains('category-btn')) {
        // 'active' í´ë˜ìŠ¤ë¥¼ ë¶™ì˜€ë‹¤ ë–¼ëŠ”(í† ê¸€) ì—­í• ë§Œ ìˆ˜í–‰
        e.target.classList.toggle('active');
      }
    });

    filterBtn.addEventListener('click', async () => {
        const startDateValue = startDateInput.value; // ì˜ˆ: "2025-07-19"
        const endDateValue = endDateInput.value;   // ì˜ˆ: "2025-07-20"

        if (!startDateValue || !endDateValue) {
            alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // [âœ… ì´ë ‡ê²Œ ìˆ˜ì •ë©ë‹ˆë‹¤]
        // new Date()ì™€ .toISOString()ì„ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
        // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œ ë¬¸ìì—´ì— ì‹œê°„ ì •ë³´ë§Œ ë¶™ì—¬ì„œ DBë¡œ ë³´ë‚¼ ë¬¸ìì—´ì„ ë§Œë“­ë‹ˆë‹¤.
        // ì´ë ‡ê²Œ í•˜ë©´ ì‹œê°„ëŒ€ ë³€í™˜ì´ ì „í˜€ ì¼ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const startDateForDB = `${startDateValue} 00:00:00`;
        const endDateForDB = `${endDateValue} 23:59:59`;

        console.log("ğŸ“Š ì°¨íŠ¸ í•„í„°ë§ ì¡°íšŒ ì‹œì‘ (ì‹œê°„ëŒ€ ë³€í™˜ ì—†ìŒ)", {
            "ì‚¬ìš©ì ì„ íƒ ì‹œì‘ì¼": startDateValue,
            "ì‚¬ìš©ì ì„ íƒ ì¢…ë£Œì¼": endDateValue,
            "DB ì¡°íšŒ ì‹œì‘ì¼ì‹œ": startDateForDB,
            "DB ì¡°íšŒ ì¢…ë£Œì¼ì‹œ": endDateForDB
        });

        const selectedChartTypes = Array.from(typeButtonsContainer.querySelectorAll('.type-btn.active')).map(btn => btn.dataset.type);
        const chartTypesToQuery = [...selectedChartTypes];
        if (selectedChartTypes.includes('ì¶œê¸ˆ') && !chartTypesToQuery.includes('ì¶œê¸ˆì·¨ì†Œ')) {
            chartTypesToQuery.push('ì¶œê¸ˆì·¨ì†Œ');
        }

        if (chartTypesToQuery.length === 0) {
            alert('í•˜ë‚˜ ì´ìƒì˜ ì¢…ë¥˜(ì…ê¸ˆ/ì¶œê¸ˆ)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const selectedChartCategories = Array.from(categoryButtonsContainer.querySelectorAll('.category-btn.active')).map(btn => btn.dataset.category);
        if (selectedChartCategories.length === 0) {
            alert('í•˜ë‚˜ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const chartMemoText = memoSearchInput.value.trim();
        
        // ìƒì„±ëœ 'YYYY-MM-DD HH:mm:ss' í˜•ì‹ì˜ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
        await fetchDataAndDisplayResults(startDateForDB, endDateForDB, selectedChartCategories, chartTypesToQuery, chartMemoText);
    });

    function applyTableFilters() {
        const startDate = tableStartDate.value;
        const endDate = tableEndDate.value;
        const selectedType = tableTypeFilter.value;
        const selectedCategory = tableCategoryFilter.value;
        const searchText = tableMemoSearch.value.toLowerCase().trim();
        const storeSearchText = tableStoreSearch.value.toLowerCase().trim();

        const tableRows = document.querySelectorAll('#log-table tbody tr');

        tableRows.forEach(row => {
            // 1. rowì— ì €ì¥ëœ UTC ì‹œê°„(ISO ë¬¸ìì—´)ì„ ê°€ì ¸ì˜¨ë‹¤.
            const rowTimelineUTC = row.dataset.timeline;
            if (!rowTimelineUTC) { // timeline ë°ì´í„°ê°€ ì—†ëŠ” rowëŠ” ë¬´ì‹œ
                row.style.display = 'none';
                return;
            }

            // 2. UTC ë¬¸ìì—´ë¡œ KST ê¸°ì¤€ì˜ Date ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
            const rowKSTDateStr = formatDateForInput(rowTimelineUTC);
            
            const rowType = row.querySelector('.type-select')?.value;
            const rowCategory = row.querySelector('.category-select')?.value;
            const memoText = (row.querySelector('.memo-input')?.value || '').toLowerCase();
            const storeText = (row.querySelector('.store-cell')?.textContent || '').toLowerCase();

            // í•„í„° ì¡°ê±´ ê²€ì‚¬
            const dateMatch = (!startDate || rowKSTDateStr >= startDate) && (!endDate || rowKSTDateStr <= endDate);
            
            let typeMatch = true;
            if (selectedType === 'ì¶œê¸ˆ') {
                typeMatch = (rowType === 'ì¶œê¸ˆ' || rowType === 'ì¶œê¸ˆì·¨ì†Œ');
            } else if (selectedType !== 'all') {
                typeMatch = (rowType === selectedType);
            }

            const categoryMatch = selectedCategory === 'all' || rowCategory === selectedCategory;
            const memoMatch = memoText.includes(searchText);
            const storeMatch = storeText.includes(storeSearchText);

            // ìµœì¢…ì ìœ¼ë¡œ ë³´ì—¬ì¤„ì§€ ë§ì§€ ê²°ì •
            if (dateMatch && typeMatch && categoryMatch && memoMatch && storeMatch) {
                row.style.display = ''; // í…Œì´ë¸”ì˜ ê¸°ë³¸ tr display ì†ì„±ìœ¼ë¡œ ë³µì›
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    async function fetchDataAndDisplayResults(startDate, endDate, categories, typesToQuery, memoText) {
        // 1. DBì—ì„œ ë°ì´í„° ì¡°íšŒ
        let query = supa.from('card_logs').select('category, amount, type')
            .in('type', typesToQuery)
            .gte('timeline', startDate)
            .lte('timeline', endDate)
            .in('category', categories);
        if (memoText) query = query.ilike('memo', `%${memoText}%`);

        const { data: rawData, error } = await query;
        if (error) { /* ... */ return; }

        // 2. ì´ì•¡ ê³„ì‚° ë° í™”ë©´ í‘œì‹œ
        let totalDeposit = 0;
        let totalWithdrawal = 0;
        rawData.forEach(item => {
            if (item.type === 'ì…ê¸ˆ') totalDeposit += item.amount;
            else if (item.type === 'ì¶œê¸ˆ') totalWithdrawal += item.amount;
            else if (item.type === 'ì¶œê¸ˆì·¨ì†Œ') totalWithdrawal -= item.amount;
        });
        document.getElementById('total-deposit').textContent = `${formatNumber(totalDeposit)} ì›`;
        document.getElementById('total-withdrawal').textContent = `${formatNumber(totalWithdrawal)} ì›`;
        document.getElementById('summary-container').style.display = 'block';

        // 3. ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„° ì§‘ê³„
        const depositCategoryTotals = {};
        const withdrawalCategoryTotals = {};
        categories.forEach(cat => {
            depositCategoryTotals[cat] = 0;
            withdrawalCategoryTotals[cat] = 0;
        });
        rawData.forEach(item => {
            if (item.type === 'ì…ê¸ˆ') {
                if (depositCategoryTotals.hasOwnProperty(item.category)) depositCategoryTotals[item.category] += item.amount;
            } else if (item.type === 'ì¶œê¸ˆ' || item.type === 'ì¶œê¸ˆì·¨ì†Œ') {
                if (withdrawalCategoryTotals.hasOwnProperty(item.category)) {
                    if(item.type === 'ì¶œê¸ˆ') withdrawalCategoryTotals[item.category] += item.amount;
                    else withdrawalCategoryTotals[item.category] -= item.amount;
                }
            }
        });

        // 4. â˜…â˜…â˜… ì‹¤ì œ ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„°ë§Œ í•„í„°ë§ â˜…â˜…â˜…
        const dynamicLabels = [];
        const dynamicDepositValues = [];
        const dynamicWithdrawalValues = [];
        categories.forEach(label => {
            const depositValue = depositCategoryTotals[label] || 0;
            const withdrawalValue = withdrawalCategoryTotals[label] || 0;
            if (depositValue > 0 || withdrawalValue > 0) {
                dynamicLabels.push(label);
                dynamicDepositValues.push(depositValue);
                dynamicWithdrawalValues.push(withdrawalValue);
            }
        });

        // 5. ëª¨ë“  ê°€ê³µì´ ëë‚œ ìµœì¢… ë°ì´í„°ë¥¼ ë‹¤ìŒ í•¨ìˆ˜ì— ì „ë‹¬
        renderDualCategoryChart(dynamicLabels, dynamicDepositValues, dynamicWithdrawalValues, totalDeposit, totalWithdrawal);
    }
        
    function renderDualCategoryChart(chartLabels, depositValues, withdrawalValues, totalDeposit, totalWithdrawal) {
        const chartContainer = document.getElementById('chart-container');
        const ctx = document.getElementById('category-chart').getContext('2d');
        
        if (categoryChart) {
            categoryChart.destroy();
        }

        // â˜…â˜…â˜… (í•µì‹¬) ê°€ìš´ë° ì •ë ¬ì„ ìœ„í•œ íŒ¨ë”© ë¡œì§ â˜…â˜…â˜…
        // ì´ í•¨ìˆ˜ëŠ” ì´ì œ ë°ì´í„° ê°€ê³µ ì—†ì´ ì „ë‹¬ë°›ì€ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const MIN_DISPLAY_CATEGORIES = 7;
        const numActiveCategories = chartLabels.length;

        let finalLabels = chartLabels;
        let finalDepositValues = depositValues;
        let finalWithdrawalValues = withdrawalValues;

        if (numActiveCategories > 0 && numActiveCategories < MIN_DISPLAY_CATEGORIES) {
            const paddingCount = Math.floor((MIN_DISPLAY_CATEGORIES - numActiveCategories) / 2);
            const labelPadding = Array(paddingCount).fill('');
            const dataPadding = Array(paddingCount).fill(null);
            finalLabels = [...labelPadding, ...chartLabels, ...labelPadding];
            finalDepositValues = [...dataPadding, ...depositValues, ...dataPadding];
            finalWithdrawalValues = [...dataPadding, ...withdrawalValues, ...dataPadding];
        }
        // â˜…â˜…â˜… íŒ¨ë”© ë¡œì§ ë â˜…â˜…â˜…


        // --- 3. ì°¨íŠ¸ ë Œë”ë§ ---
        const chartTitle = 'ì„ íƒëœ ê¸°ê°„ ë° ì¹´í…Œê³ ë¦¬ë³„ ì…/ì¶œê¸ˆ í˜„í™©';

        categoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                // â˜…â˜…â˜… íŒ¨ë”©ì´ ì ìš©ëœ ìµœì¢… ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ â˜…â˜…â˜…
                labels: finalLabels,
                datasets: [
                    {
                        label: 'ì´ ì…ê¸ˆì•¡ (ì›)',
                        data: finalDepositValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)'
                        // maxBarThickness ë“±ì€ ì´ì œ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì œê±°í•´ë„ ì¢‹ìŠµë‹ˆë‹¤.
                    },
                    {
                        label: 'ì´ ì¶œê¸ˆì•¡ (ì›)',
                        data: finalWithdrawalValues,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                // bar ê´€ë ¨ ë„ˆë¹„ ì˜µì…˜
                categoryPercentage: 0.8, // ì¹´í…Œê³ ë¦¬ ì—´ ë‚´ì—ì„œ ë§‰ëŒ€ ê·¸ë£¹ì´ ì°¨ì§€í•˜ëŠ” ë„ˆë¹„ ë¹„ìœ¨
                barPercentage: 0.7,      // ë§‰ëŒ€ ê·¸ë£¹ ë‚´ì—ì„œ ê° ë§‰ëŒ€ê°€ ì°¨ì§€í•˜ëŠ” ë„ˆë¹„ ë¹„ìœ¨
                plugins: {
                    // ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                    datalabels: {
                        display: context => context.dataset.data[context.dataIndex] > 0,
                        formatter: (value, context) => {
                            let total = context.datasetIndex === 0 ? totalDeposit : totalWithdrawal;
                            const percentage = total > 0 ? (value / total) * 100 : 0;
                            const formattedValue = new Intl.NumberFormat('ko-KR').format(value);
                            return `${formattedValue}\n(${percentage.toFixed(1)}%)`;
                        },
                        anchor: 'end',
                        align: 'center',
                        offset: 7,
                        font: {
                            family: "'Pretendard Variable', sans-serif", // ì›í•˜ëŠ” í°íŠ¸ íŒ¨ë°€ë¦¬ ì§€ì •
                            weight: '400',
                            size: 11,
                            lineHeight: 1.2 // ì¤„ ê°„ê²© ì¡°ì ˆ
                        },
                        color: '#333'
                    },
                    title: { display: true, text: chartTitle, font: { size: 16 } },
                    legend: { position: 'top' },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          let label = context.dataset.label || '';
                          if (label) { label += ': '; }
                          if (context.parsed.y !== null) {
                              label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + ' ì›';
                          }
                          return label;
                        }
                      }
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        ticks: {
                            callback: value => new Intl.NumberFormat('ko-KR').format(value)
                        },
                        grace: '20%'
                    }
                }
            }
        });
        chartContainer.style.display = 'block';
    }

    // [ìˆ˜ì •] ëª¨ë“  í•„í„° ì´ë²¤íŠ¸ê°€ í†µí•© í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì—°ê²°
    tableStartDate.addEventListener('change', applyTableFilters);
    tableEndDate.addEventListener('change', applyTableFilters);
    tableTypeFilter.addEventListener('change', applyTableFilters); // ìƒˆë¡œ ì¶”ê°€ëœ ë“œë¡­ë‹¤ìš´ì˜ ì´ë²¤íŠ¸
    tableCategoryFilter.addEventListener('change', applyTableFilters);
    tableMemoSearch.addEventListener('input', applyTableFilters);
    tableStoreSearch.addEventListener('input', applyTableFilters);

    //=======================================================
    // ê¸°ì¡´ í…Œì´ë¸” ê´€ë ¨ ë¡œì§
    //=======================================================
    async function loadInitialLogs() {
      const { data, error } = await supa
        .from('card_logs')
        .select('*')
        .order('timeline', { ascending: true });

      if (error) {
        console.error('ì´ˆê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
        return;
      }

      const tbody = document.querySelector('#log-table tbody');
      tbody.innerHTML = '';

      data.forEach(row => { // reverse()ë¥¼ ì œê±°í•˜ê³  forEachë¡œ ë³€ê²½
        appendRow(row);     // appendRowëŠ” ì´ì œ prependë¡œ ë™ì‘í•˜ë¯€ë¡œ ìˆœì„œê°€ ë§ìŒ
      });
      
      // ëª¨ë“  ë°ì´í„°ë¥¼ DOMì— ì¶”ê°€í•œ í›„, ë§ˆì§€ë§‰ì— í•„í„°ë¥¼ í•œë²ˆ ì „ì²´ ì ìš©
      applyTableFilters(); 
    }

    function formatNumber(num) {
      return typeof num === 'number' ? num.toLocaleString('ko-KR') : '';
    } 

    function formatDateCompact(dateString) {
      if (!dateString || dateString.length < 16) return '';

      // "2025-07-19T18:54:00+00:00" í˜•íƒœì˜ ë¬¸ìì—´ì„ ê°€ì •
      const month = dateString.substring(5, 7);
      const day = dateString.substring(8, 10);
      const hour = dateString.substring(11, 13);
      const minute = dateString.substring(14, 16);

      return `${month}/${day} ${hour}:${minute}`;
    }


    function appendRow(row) {
        const tbody = document.querySelector('#log-table tbody');
        const tr = document.createElement('tr');
        // KST/UTC í˜¼ë™ì„ ë§‰ê¸° ìœ„í•´ ê¸°ì¤€ì´ ë˜ëŠ” UTC ì‹œê°„ì„ data ì†ì„±ì— ì €ì¥
        tr.dataset.timeline = row.timeline;

        const categoryOptions = categories.map(cat =>
            `<option value="${cat}" ${row.category === cat ? 'selected' : ''}>${cat}</option>`
        ).join('');
        const typeOptions = ['ì¶œê¸ˆ', 'ì…ê¸ˆ', 'ì¶œê¸ˆì·¨ì†Œ', 'ê¸°íƒ€'].map(type =>
            `<option value="${type}" ${row.type === type ? 'selected' : ''}>${type}</option>`
        ).join('');

        let typeClass = '';
        if (row.type === 'ì…ê¸ˆ') typeClass = 'deposit';
        else if (row.type === 'ì¶œê¸ˆ') typeClass = 'withdrawal';
        else if (row.type === 'ì¶œê¸ˆì·¨ì†Œ') typeClass = 'cancel';
        else typeClass = 'other';

        tr.innerHTML = `
            <td>${formatDateCompact(row.timeline)}</td>
            <td>
                <select class="form-select form-select-sm category-select" data-id="${row.id}" onchange="updateCategory(this)">
                    <option value="" disabled ${!row.category ? 'selected' : ''}>ì„ íƒ</option>
                    ${categoryOptions}
                </select>
            </td>
            <td>${row.amount.toLocaleString('ko-KR')}</td>
            <td>${row.card}</td>
            <td>  
                <select class="form-select form-select-sm type-select ${typeClass}" data-id="${row.id}" onchange="updateType(this)">
                    <option value="" disabled>ì„ íƒ</option>
                    ${typeOptions}
                </select>
            </td>
            <td>${row.balance.toLocaleString('ko-KR')}</td>
            <td class="store-cell">${row.store}</td>
            <td>
                <input type="text" class="form-control form-control-sm memo-input" value="${row.memo || ''}" 
                    data-id="${row.id}" onblur="updateMemo(this)" />
            </td>
        `;

        // ìƒˆë¡œìš´ í–‰ì„ í…Œì´ë¸”ì˜ ê°€ì¥ ìœ„ìª½ì— ì¶”ê°€
        tbody.prepend(tr);
    }


    async function updateCategory(selectEl) {
      const newCategory = selectEl.value;
      const id = selectEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ category: newCategory })
        .eq('id', id);

      if (error) {
        alert('ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        console.error(error);
      } else {
        console.log(`âœ… ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${newCategory}`);
      }
    }

    async function updateType(selectEl) {
      const newType = selectEl.value;
      const id = selectEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ type: newType })
        .eq('id', id);

      if (error) {
        alert('ì¢…ë¥˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        console.error(error);
      } else {
        console.log(`âœ… ì¢…ë¥˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${newType}`);
      }
    }

    async function updateMemo(inputEl) {
      const newMemo = inputEl.value;
      const id = inputEl.getAttribute('data-id');

      const { error } = await supa
        .from('card_logs')
        .update({ memo: newMemo })
        .eq('id', id);

      if (error) {
        alert('ë©”ëª¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        console.error(error);
      } else {
        console.log(`âœ… ë©”ëª¨ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${newMemo}`);
      }
    }

    function populateTableFilter() {
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        tableCategoryFilter.appendChild(option);
      });
    }

    // âœ… ìµœì´ˆ ì „ì²´ ë¡œë”©
    setDefaultDateRange();
    createCategoryButtons();
    populateTableFilter();
    loadInitialLogs();

    // âœ… ì‹¤ì‹œê°„ ì‚½ì…ë§Œ ê°ì§€
    supa
      .channel('realtime:card_logs')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'card_logs' },
        payload => {
          console.log('ğŸ†• ìƒˆ ë°ì´í„° ê°ì§€ë¨:', payload.new);
          appendRow(payload.new); 
        }
      )
      .subscribe();
  </script>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

</body>
</html>
