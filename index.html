<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" href="/assets/apk.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="게릴라 파티">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/common/loader/loader.css">
  <link rel="stylesheet" href="style.css" />
  <script src="/common/loader/loader.js" defer></script>
  <script src="/common/sidebar.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <title>Document</title>
</head>
<body>
  <div id="page-loader" class="page-loader">
    <div class="spinner"></div>
  </div>
    <!-- 1. 로그인 프롬프트 (새로 추가) -->
  <!-- 로그인하지 않은 사용자에게 이 부분이 보입니다. -->
  <div id="login-prompt">
    <a href="index.html" class="sidebar-head-logo">
      <span class="login-Gue">Gue</span><span class="login-rrilla">rrilla</span>
    </a>
    <h2>DASHBOARD</h2>
    <!-- Netlify Identity 로그인 버튼이 생성될 위치 -->
    <div data-netlify-identity-button></div>
  </div>
  <div id="app-content" style="display: none;">
    <div class="dashboard main-content">
      <main class="main">
        <header class="main-header d-flex justify-content-between align-items-center">
          <h1>나의 대시보드</h1>
          <div data-netlify-identity-button></div>
        </header>
        <!-- 필터 -->
        <div class="d-flex justify-content-end my-3">
          <select id="range-select" class="form-select w-auto">
            <option value="week">이번 주</option>
            <option value="month">이번 달</option>
            <option value="all">전체</option>
          </select>
        </div>

        <div class="row g-4">
          <!-- 💸 지출 카드 -->
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h5 class="mb-2">💸 지출 합계</h5>
              <div class="fs-5 fw-bold mb-3" id="expense-total">₩0</div>
              <canvas id="expenseChart" height="200"></canvas>
            </div>
          </div>

          <!-- 💰 수입 카드 -->
          <div class="col-md-3">
            <div class="card p-3 shadow-sm">
              <h5 class="mb-2">💰 수입 합계</h5>
              <div class="fs-5 fw-bold mb-3" id="income-total">₩0</div>
              <canvas id="incomeChart" height="200"></canvas>
            </div>
          </div>
        </div>

        <section id="games" class="section">
          <h2>인물게임</h2>
          <!-- 여기엔 슬라이드 이미지 게임이 들어갈 수 있음 -->
        </section>

        <section id="settings" class="section">
          <h2>설정업데이트</h2>
          <p>난이도, 문제 수, 공개 여부 등을 설정</p>
        </section>
      </main>
    </div>
  </div>
  <script src="/common/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="charts.js"></script>
  <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loginPrompt = document.getElementById('login-prompt');
      const appContent = document.getElementById('app-content');

      // UI를 업데이트하는 함수
      const updateUI = (user) => {
        if (user) {
          // 사용자가 로그인한 경우:
          loginPrompt.style.display = 'none';
          appContent.style.display = 'block';
        } else {
          // 사용자가 로그아웃한 경우:
          loginPrompt.style.display = 'flex'; // 'block'을 'flex'로 수정!
          appContent.style.display = 'none';
        }
      };

      // 1. 페이지 로드 시, 현재 로그인 상태를 확인하여 UI를 즉시 업데이트
      const currentUser = netlifyIdentity.currentUser();
      updateUI(currentUser);

      // 2. 'login' 이벤트가 발생하면 UI 업데이트
      netlifyIdentity.on('login', (user) => {
        netlifyIdentity.close(); // 이 줄이 핵심입니다! 모달(안내창)을 닫습니다.
        updateUI(user);        // 그리고 우리가 만든 UI 업데이트 함수를 실행합니다.
      });

      // 3. 'logout' 이벤트가 발생하면 UI 업데이트
      netlifyIdentity.on('logout', () => {
        // ★★★ 디버깅을 위한 로그 추가 ★★★
        console.log('★★★ 로그아웃 이벤트가 성공적으로 발생했습니다! ★★★'); 
        updateUI(null);
      });
    });
  </script>
</body>
</html>
